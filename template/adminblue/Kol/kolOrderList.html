{extend name="adminblue/base" /}
{block name="resources"/}
<script type="text/javascript" src="__STATIC__/My97DatePicker/WdatePicker.js"></script>
<link href="__STATIC__/blue/css/order/ns_orderlist.css" rel="stylesheet" type="text/css" />
<style>
	.mytable.select td{padding-bottom:0;}
	.mytable.select div{display:inline-block;margin:0 10px 10px 0;}
	.mytable.select #more_search{display: block;}
	.table-class tbody td a {margin-left: 0;}
	.black_tech {font-size: 12px;margin-right: 5px;font-style: normal;color: #fff;background-color: black;border-radius: 2px;padding: 1px 2px}
	.order-tool{display: inline;position: absolute;margin-top: 10px;margin-left: 16px;}
	.to-fixed{position: fixed;width: 85.5%;top: 50px;box-shadow: 0 2px 6px 0 rgba(0,0,0,.3);z-index: 5;}
</style>
{/block}
{block name="main"}
<input type="hidden" id="order_id" />
<input type="hidden" id="print_select_ids" />
<input type="hidden" id="order_status" value="{$status}" />
<div style="border:1px solid #e5e5e5;">
	<table class="mytable select">
		<tr>
			<td style="text-align: left">
				<div>
					<span>订单编号：</span>
					<input id="orderNo" class="input-common w100" type="text" />
					<span>发货时间：</span>
					<input type="text" id="startDate" class="input-common w100" placeholder="请选择开始日期" onclick="WdatePicker()" />
					&nbsp;-&nbsp;
					<input type="text" id="endDate" placeholder="请选择结束日期" class="input-common w100" onclick="WdatePicker()" />
				</div>
				<div style="margin-right: 4px;">
					<span>来源网点：</span>
					<select id="source_branch" class="select-common w100">
						<option value="">全部</option>
						<option value="0">--</option>
						{volist name="$storeList" id="vo"}
						<option value="{$vo.store_id}">{$vo.store_name}</option>
						{/volist}
					</select>
				</div>
				<!--<div style="margin-right: 4px;">-->
					<!--<span>极选师：</span>-->
					<!--<select id="source_distribution" class="select-common w100">-->
						<!--<option value="">全部</option>-->
						<!--{volist name="$kolList" id="vo"}-->
						<!--<option value="{$vo.uid}">{$vo.real_name}</option>-->
						<!--{/volist}-->
					<!--</select>-->
				<!--</div>-->
				<input type="text" id='search_text' placeholder="请输入极选师姓名" class="input-common" style="width: 162px" />
				<input type="button" onclick="searchData()" value="搜索" class="btn-common" />
				<input class="btn-common" type="button" onclick="dataExcel()" value="导出数据"/>
				<div>
					<!--<input class="btn-common" type="button" onclick="searchData()" value="搜索"/>-->
					<!--<input class="btn-common" type="button" onclick="update()" value="更新数据"/>-->
				</div>
			</td>
		</tr>
	</table>
	<div class="divider"></div>
	<div style="min-height: 53px;">
		<nav class="order-nav">
			<ul>
				{foreach name="child_menu_list" item="child_menu" key="k" }
				{eq name="child_menu['active']" value="1"}
				<li class="selected"><a href="{:__URL('ADMIN_MAIN/'.$child_menu['url'])}">{$child_menu.menu_name}</a></li>
				{else/}
				<li><a href="{:__URL('ADMIN_MAIN/'.$child_menu['url'])}">{$child_menu.menu_name}</a></li>
				{/eq}
				{/foreach}
			</ul>
		</nav>
	</div>
	<table class="table-class">
		<colgroup>
			<col width="15%">
			<col width="10%">
			<col width="10%">
			<col width="11%">
			<col width="8%">
			<col width="14%">
			<col width="8%">
			<col width="8%">
			<col width="8%">
			<col width="8%">
		</colgroup>
		<thead>
		<tr align="center">
			<th>商品信息</th>
			<th>商品清单</th>
			<th>买家</th>
			<th>订单金额</th>
			<th>来源网点</th>
			<th>极选师&推荐人&邀请人</th>
			<th>分润比例</th>
			<th>直接分润</th>
			<th>间接分润</th>
			<th>订单状态</th>
		</tr>
		</thead>
		<tbody></tbody>
	</table>

	<div class="modal hide fade" id="checkout" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="left:45%;width:50%">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
					<h3>分润出账</h3>
				</div>
				<div class="modal-body">
					<!-- 主要内容 -->
					<div>待出账(<span id="order_num"></span>)，已选<span id="checkedbox">0</span></div>
					<table class="table table-hover" style="margin-bottom:10px;">
						<thead>
						<tr>
							<td>
								<label class="checkbox-inline">
									<input type="checkbox" id="inlineCheckbox1" onclick="checkoutCheckAll(this)">
								</label>
							</td>
							<td>分润类型</td>
							<td>分润金额</td>
							<td>出账时间</td>
							<td>状态</td>
						</tr>
						</thead>
						<colgroup>
							<col style="width: 5%;">
							<col style="width: 25%;">
							<col style="width: 25%;">
							<col style="width: 25%;">
							<col style="width: 20%;">
						<colgroup>
						<tbody></tbody>
					</table>
				</div>

				<div class="modal-footer">
					<button class="btn btn-primary" onclick="checkoutSubmit()">确定出账</button>
					<button class="btn" data-dismiss="modal">关闭</button>
				</div>
			</div>
		</div>
	</div>
</div>
{/block}
{block name="script"}
<script type="text/javascript">
function checkout(order_no){
	$("#checkout").modal('show');
	$("#checkout .modal-body table tbody tr").remove();
	$.ajax({
		type : "post",
		url  : "{:__URL('ADMIN_MAIN/Distributor/orderSeparationRecordsList')}",
		data : {
			'order_no':order_no
		},
		success : function(data) {
			var order_html = '';
			var order_num = 0;
			if (data.length > 0) {
				for (var i = 0; i < data.length; i++) {
					if (data[i]['is_checkout'] == 0) {
						order_num++;
					}
					order_html += '<tr>';
					if (data[i]['is_checkout'] == 1) {
						order_html += '<td><label class="checkbox-inline"><input type="checkbox" value="' + data[i]['is_checkout'] + '" disabled="true"></label></td>';
					} else {
						order_html += '<td><label class="checkbox-inline"><input type="checkbox" id="' + data[i]['id'] + '" value="' + data[i]['is_checkout'] + '" onclick="checkoutCheck(this)"></label></td>';
					}
					order_html += '<td>' + data[i]['text'] + '</td>';
					order_html += '<td>' + Number(data[i]['separation_money']).toFixed(2) + '</td>';

					order_html += '<td>' + timeStampTurnTime(data[i]["checkout_time"]) + '</td>';
					if (data[i]['is_checkout'] == 0) {
						order_html += '<td style="color:red">未出账</td>';
					} else {
						order_html += '<td>已出账</td>';
					}

					order_html += '</tr>';
				}
			}else{
				order_html += '<tr align="center"><td colspan="6">暂无符合条件的数据</td></tr>';
			}
			$("#order_num").html(order_num);
			$("#checkout .modal-body table tbody").append(order_html);
		}
	});
}

function checkoutCheckAll(event){
	var checked = event.checked;
	$("#checkout .modal-body table tbody input[type = 'checkbox'][value = 0]").prop("checked",checked);
	var obj = $("#checkout .modal-body table tbody input[type = 'checkbox'][value = 0][checked]");
	$("#checkedbox").html(obj.length);
}

function checkoutCheck(event){
	var obj = $("#checkout .modal-body table tbody input[type = 'checkbox'][value = 0][checked]");
	$("#checkedbox").html(obj.length);
}

var flag = false;
function checkoutSubmit(){
	var id_array = '';
	$("#checkout .modal-body table tbody input[type = 'checkbox'][value = 0][checked]").each(function(i){
		if(0==i){
			id_array = $(this).attr('id');
		}else{
			id_array += (","+$(this).attr('id'));
		}
	});
	if(id_array == ''){
		showTip("至少选择一笔分润",'warning');
		return false;
	}
	if(flag){
		return;
	}
	flag = true;
	$.ajax({
		type : "post",
		url : "{:__URL('ADMIN_MAIN/Distributor/checkoutSubmit')}",
		data : {'id_array':id_array},
		success : function(data) {
			$("#checkout").modal('hide');
			if (data['code'] > 0) {
				showMessage('success', data["message"],window.location.reload());
			} else {
				showMessage('error', data["message"]);
				flag = false;
			}
		}
	});
}
function update() {
	$.ajax({
		type : "post",
		url : "{:__URL('ADMIN_MAIN/Distributor/update')}",
		data : {},
		success : function(data) {
			if (data['code'] > 0) {
				showMessage('success', data["message"]);
			} else {
				showMessage('error', data["message"]);
			}
		}
	});

}


//订单数据导出
function dataExcel(){
	var order_no = $("#orderNo").val();
	var start_date = $("#startDate").val();
	var end_date = $("#endDate").val();
	var source_branch = $("#source_branch").val();
//	var source_distribution = $("#source_distribution").val();
	var order_status = $("#order_status").val();
	window.location.href=__URL("ADMIN_MAIN/Distributor/kolOrderDataExcel?order_no="+order_no+"&start_date="+start_date+"&end_date="+end_date+"&source_branch="+source_branch+"&order_status="+order_status);
}

function searchData(){
	LoadingInfo(1);
}

function LoadingInfo(page_index) {
	var order_no 			= $("#orderNo").val();
	var start_date 			= $("#startDate").val();
	var end_date 			= $("#endDate").val();
	var source_branch 		= $("#source_branch").val();
//	var source_distribution = $("#source_distribution").val();
	var order_status	    = $("#order_status").val();
	var search_text 		= $("#search_text").val();
	$.ajax({
		type : "post",
		url : "{:__URL('ADMIN_MAIN/Distributor/kolOrderList')}",
		data : {
			"page_index" : page_index,
			"page_size" : $("#showNumber").val(),
			"order_no" : order_no,
			"start_date" : start_date,
			"end_date" : end_date,
			"source_branch" : source_branch,
//			"source_distribution" : source_distribution,
			"order_status" : order_status,
			"search_text" : search_text
		},
		success : function(data) {
			var html = '';
			if (data["data"].length > 0) {
				for (var i = 0; i < data["data"].length; i++) {
					var order_id = data["data"][i]["order_id"];//订单id
					var order_no = data["data"][i]["order_no"];//订单编号
					var out_trade_no = data["data"][i]["out_trade_no"];//交易号
					var create_time = timeStampTurnTime(data["data"][i]["create_time"]);//创建时间
					var consign_time = timeStampTurnTime(data["data"][i]["consign_time"]);//发货时间
					var is_inside = data["data"][i]["is_inside"];//是否内购
					var pic_cover_micro = data["data"][i]["order_item_list"][0]["picture"]['pic_cover_micro'];//商品图
					var goods_id = data["data"][i]["order_item_list"][0]["goods_id"];//商品id
					var goods_name = data["data"][i]["order_item_list"][0]["goods_name"];
					var sku_name = data["data"][i]["order_item_list"][0]["sku_name"];//商品sku
					var price = data["data"][i]["order_item_list"][0]["price"];//商品价格
					var num = data["data"][i]["order_item_list"][0]["num"];//购买数量
					var order_money = data["data"][i]["order_money"];//订单金额
					var shipping_money = data["data"][i]["shipping_money"];//运费
					var seller_memo = data["data"][i]["seller_memo"];//订单备注
					var goods_code = data["data"][i]["order_item_list"][0]["code"];
					var gift_flag = data['data'][i]['order_item_list'][0]['gift_flag'];//赠品标识，0：不是赠品，1：是赠品

					//---------------colspan
					html += '<tr class="title-tr">';
					html += '<td colspan="11"><input id="'+out_trade_no+'" type="checkbox" value="'+order_id+'" name="sub">';
					html +='<span>订单编号：'+order_no+' 商户订单号：'+out_trade_no+'</span>';
					if(create_time){
						html +='<span>创建时间：'+create_time+'</span>';
					}
					if(consign_time){
						html +='<span>发货时间：'+consign_time+'</span>';
					}
					if(is_inside == 1){
						html += '<span class="black_tech">内购</span>';
					}
					html += '</td></tr>';

					//---------------商品信息
					html += '<tr><td>';
					html += '<div class="product-img"><img src="'+__IMG(pic_cover_micro)+'"></div>';
					html += '<div class="product-infor">';
					html += '<span>'+goods_name+'</span>';
					if(sku_name != null && sku_name != ""){
						html += '<p class="specification" style="margin-bottom: 0px;"><span style="color:#8e8c8c;font-size:12px;">'+sku_name+'</span></p>';
					}
					if(goods_code != null && goods_code != ""){
						html += '<p class="specification"><span style="color:#8e8c8c;font-size:12px;">'+goods_code+'</span></p></div>';
					}

					//添加赠品标识
					if(gift_flag > 0){
						html += '<i style="font-size:12px;margin:5px 5px 0 0;padding:1px 4px;border-radius:3px;display:inline-block;color:#FFF;background-color:#de533c;height:16px;line-height: 16px;overflow:hidden;font-style:normal;">赠品</i>';
					}

					//添加会员礼标识
					if(gift_flag == -1){
						html += '<i style="font-size:12px;margin:5px 5px 0 0;padding:1px 4px;border-radius:3px;display:inline-block;color:#FFF;background-color:#de533c;height:16px;line-height: 16px;overflow:hidden;font-style:normal;">会员礼</i>';
					}
					html += '</div></td>';

					//---------------------商品清单
					//订单数量大于1个，调整样式
					if(data["data"][i]["order_item_list"].length>1){

						html += '<td>';
						html += '<div class="cell" style="display: inline-block;"><span>'+price+'元</span></div>';
						html += '<div class="cell" style="display: inline-block;float:right;">'+num+'件</div>';
					}else{
						html += '<td style="text-align:center;">';

						html += '<div class="cell" style="display: inline-block;"><span>'+price+'元</span></div>';
						html += '<div class="cell">'+num+'件</div>';
					}

					//调价
					if(data["data"][i]["order_item_list"][0]['adjust_money'] != 0){
						if(data["data"][i]["order_item_list"][0]['adjust_money'] > 0){
							var adjust_money = data["data"][i]["order_item_list"][0]["adjust_money"];
							html += '<div class="cell" style="display: inline-block;"><span>(调价：'+adjust_money+'元)</span></div>';

						}else{
							var adjust_money = data["data"][i]["order_item_list"][0]["adjust_money"];
							var adjust_new_moeny = (Number(price * num) + Number(adjust_money)) / Number(price * num) / 10;
							var adjust_point =  (adjust_new_moeny * 100).toFixed(2);
							html += '<div class="cell" style="display: inline-block;"><span>(调价：'+adjust_money+'元)</span><br><span style="color: red">'+ adjust_point +'折</span></div>';
						}

					}

					if(	data["data"][i]["order_item_list"][0]['refund_status'] != 0){
						//退款
						var order_goods_id = data["data"][i]["order_item_list"][0]["order_goods_id"];//订单项id
						var status_name = data["data"][i]["order_item_list"][0]["status_name"];//状态

						//订单数量大于1个，调整样式
						if(data["data"][i]["order_item_list"].length>1){
							html +='<a href="'+__URL('ADMIN_MAIN/order/orderrefunddetail?itemid='+order_goods_id)+'" style="margin:5px 0 10px 0;display:block;text-align:center;">'+status_name+'</a>';
						}else{
							html +='<a href="'+__URL('ADMIN_MAIN/order/orderrefunddetail?itemid='+order_goods_id)+'" style="margin:5px 0 10px 0;display:block;">'+status_name+'</a>';
						}

					}
					html += '</td>';


					var row=1;//订单数量，用于设置跨行
					if(data["data"][i]["order_item_list"].length!=null)
					{
						row=data["data"][i]["order_item_list"].length;
					}

					//-----------------买家
					html += '<td rowspan="'+row+'" style="text-align:center"><div class="cell">'+data["data"][i]["user_name"]+'<br/>';
					html += '<i class="'+data["data"][i]["order_from_tag"]+'" style="color:#666;"><i></div></td>';

					//-----------------订单金额
					html += '<td rowspan="'+row+'" style="text-align:center">';
					html += '<div class="cell"><b class="netprice" style="color:#666;">'+order_money+'</b><br/>';
					html += '<span class="expressfee">(含快递:'+shipping_money+'元)</span><br/>';
					html += '<span class="expressfee">'+data["data"][i]["pay_type_name"]+'</span></div></td>';

					//-----------------来源网点
					html += '<td rowspan="'+row+'" style="text-align:center">' + data["data"][i]["source_branch_name"] + '</td>';

					//-----------------极选师/推荐人
					html += '<td rowspan="'+row+'" style="text-align:center">' + data["data"][i]["source_distribution_name"] + ' & '+data["data"][i]["parent_source_distribution_name"]+ ' & '+data["data"][i]["inviter_name"]+'</td>';

					//------------------分润比例
					html += '<td style="text-align:center">' + Math.round(data["data"][i]["order_item_list"][0]['all_fraction'] * 100) + '%</td>';

					//------------------直接分润
					html += '<td style="text-align:center">' + data["data"][i]["order_item_list"][0]['direct_separation'] + '</td>';

					//------------------间接分润
					html += '<td style="text-align:center">' + data["data"][i]["order_item_list"][0]['indirect_separation'] + '</td>';

					//----------------订单状态
//					html += '<td rowspan="'+row+'" style="text-align:center">'+data["data"][i]["status_name"]+'</td>';

					//------------------详情
					html += '<td rowspan="'+row+'" style="text-align:center;">';
					html += '<span>'+data["data"][i]["status_name"]+'</span>';
//					if(data["data"][i]["separation_status"] == 1){
//						html += '<a style="cursor: pointer;" onclick="checkout('+order_no+')">待出账</a>';
//					}else if(data["data"][i]["separation_status"] == 2){
//						 html += '<a style="cursor: pointer;" onclick="checkout('+order_no+')">已出账</a>';
//					}else{
//						 html += '<span></span>';
//					 }
					html +='</td></tr>';
					//循环订单项
					//前边已经加载过一次了，所以从第二次开始循环
					for(var j = 1; j < data["data"][i]["order_item_list"].length; j++){
						var pic_cover_micro = data["data"][i]["order_item_list"][j]["picture"]['pic_cover_micro'];//商品图
						var goods_id = data["data"][i]["order_item_list"][j]["goods_id"];//商品id
						var goods_name = data["data"][i]["order_item_list"][j]["goods_name"];//商品名称
						var sku_name = data["data"][i]["order_item_list"][j]["sku_name"];//sku名称
						var price = data["data"][i]["order_item_list"][j]["price"];//价格
						var num = data["data"][i]["order_item_list"][j]["num"];//购买数量
						var gift_flag = data["data"][i]["order_item_list"][j]["gift_flag"];//赠品标识，0：不是赠品，1：是赠品
						var goods_code = data["data"][i]["order_item_list"][j]["code"];

						//---------------商品信息
						html += '<tr calss="no-rightborder"><td colspan="1">';
						html += '<div class="product-img"><img src="'+__IMG(pic_cover_micro)+'"></div>';
						html += '<div class="product-infor">';
						html += '<span>'+goods_name+'</span>';
						if(sku_name != null && sku_name != ''){
							html += '<p class="specification" style="margin-bottom: 0px;"><span style="color:#8e8c8c;font-size:12px;">'+sku_name+'</span></p>';
						}
						if(goods_code != null && goods_code != ''){
							html += '<p class="specification"><span style="color:#8e8c8c;font-size:12px;">'+goods_code+'</span></p>';
						}

						//添加赠品标识
						if(gift_flag > 0){
							html += '<i style="font-size:12px;margin:5px 5px 0 0;padding:1px 4px;border-radius:3px;display:inline-block;color:#FFF;background-color:#de533c;height:16px;line-height: 16px;overflow:hidden;font-style:normal;">赠品</i>';
						}
						html += '</div></td>';

						//---------------------商品清单
						//只给中间的商品加
						if((j+1) != data["data"][i]["order_item_list"].length){
							html += '<td style="border-left:0px solid #fff;border-bottom:1px solid #e5e5e5;">';//商品信息与商品清单的分割线
						}else{
							html += '<td style="border-left:0px solid #fff;">';//商品信息与商品清单的分割线
						}

						//添加赠品标识
						html += '<div class="cell" style="display: inline-block;"><span>'+price+'元</span></div>';
						html += '<div class="cell" style="display: inline-block;float:right">'+num+'件</div>';

						//调价
						if(data["data"][i]["order_item_list"][j]['adjust_money'] != 0){
							if(data["data"][i]["order_item_list"][j]['adjust_money'] > 0){
								var adjust_money = data["data"][i]["order_item_list"][j]["adjust_money"];
								html += '<div class="cell" style="display: inline-block;"><span>(调价：'+adjust_money+'元)</span></div>';

							}else{
								var adjust_money = data["data"][i]["order_item_list"][j]["adjust_money"];
								var adjust_new_moeny = (Number(price * num) + Number(adjust_money)) / Number(price * num) / 10;
								var adjust_point =  (adjust_new_moeny * 100).toFixed(2);
								html += '<div class="cell" style="display: inline-block;"><span>(调价：'+adjust_money+'元)</span><br><span style="color: red">'+ adjust_point +'折</span></div>';
							}

						}

						if(data["data"][i]["order_item_list"][j]['refund_status'] != 0){
							//退款
							var order_goods_id = data["data"][i]["order_item_list"][j]["order_goods_id"];//订单项id
							var status_name = data["data"][i]["order_item_list"][j]["status_name"];//订单状态
							html +='<br><a href="'+__URL('ADMIN_MAIN/order/orderrefunddetail?itemid='+order_goods_id)+'" style="margin:5px 0 10px 0;display:block;text-align:center;">'+status_name+'</a>';
						}
						html += '</td>';
						//------------------分润比例
						html += '<td style="text-align:center">' + Math.round(data["data"][i]["order_item_list"][j]['all_fraction'] * 100) + '%</td>';

						//------------------直接分润
						html += '<td style="text-align:center;border-top: 1px solid #e5e5e5">' + data["data"][i]["order_item_list"][j]['direct_separation'] + '</td>';

						//------------------间接分润
						html += '<td style="text-align:center;border-top: 1px solid #e5e5e5">' + data["data"][i]["order_item_list"][j]['indirect_separation'] + '</td>';
						html +='</tr>';
					}
				}
			} else {
				html += '<tr align="center"><td colspan="10">暂无符合条件的订单</td></tr>';
			}
			$(".table-class tbody").html(html);
			initPageData(data["page_count"],data['data'].length,data['total_count']);
			$("#pageNumber").html(pagenumShow(jumpNumber,$("#page_count").val(),{$pageshow}));
		}
	});
}
</script>
{/block}