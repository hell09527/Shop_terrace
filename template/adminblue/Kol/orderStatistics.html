{extend name="adminblue/base" /}
{block name="resources"/}
<style type="text/css">
	.goods-fields-sort {
		cursor: pointer;
	}

	.goods-fields-sort span {
		background: url('ADMIN_IMG/goods_sort.png') no-repeat;
		width: 20px;
		height: 20px;
		display: inline-block;
		margin-left: 5px;
		vertical-align: middle;
		position: absolute;
	}

	.goods-fields-sort span.asc {
		background-position: 0 5px;
	}

	.goods-fields-sort span.selected.asc {
		background-position: -30px 5px;
	}

	.goods-fields-sort span.desc {
		background-position: 0 -24px;
	}

	.goods-fields-sort span.selected.desc {
		background-position: -30px -24px;
	}
</style>
{/block}
{block name="main"}
<div style="border:1px solid #e5e5e5;">
	<table class="mytable select">
		<tr>
			<td>
				<div>
					<span>结算时间：</span>
					<select id="year" class="select-common w100">
						<option value="2017" {if condition="$year eq 2017"}selected="selected"{/if}>2017</option>
						<option value="2018" {if condition="$year eq 2018"}selected="selected"{/if}>2018</option>
						<option value="2019" {if condition="$year eq 2019"}selected="selected"{/if}>2019</option>
						<option value="2020" {if condition="$year eq 2020"}selected="selected"{/if}>2020</option>
					</select>
					<select id="month" class="select-common w100">
						<option value="1" {if condition="$month eq 1"}selected="selected"{/if}>01</option>
						<option value="2" {if condition="$month eq 2"}selected="selected"{/if}>02</option>
						<option value="3" {if condition="$month eq 3"}selected="selected"{/if}>03</option>
						<option value="4" {if condition="$month eq 4"}selected="selected"{/if}>04</option>
						<option value="5" {if condition="$month eq 5"}selected="selected"{/if}>05</option>
						<option value="6" {if condition="$month eq 6"}selected="selected"{/if}>06</option>
						<option value="7" {if condition="$month eq 7"}selected="selected"{/if}>07</option>
						<option value="8" {if condition="$month eq 8"}selected="selected"{/if}>08</option>
						<option value="9" {if condition="$month eq 9"}selected="selected"{/if}>09</option>
						<option value="10" {if condition="$month eq 10"}selected="selected"{/if}>10</option>
						<option value="11" {if condition="$month eq 11"}selected="selected"{/if}>11</option>
						<option value="12" {if condition="$month eq 12"}selected="selected"{/if}>12</option>
					</select>
					<span>极选师：</span>
					<!--<select id="source_distribution" class="select-common w100">-->
						<!--<option value="">全部</option>-->
						<!--{volist name="$kolList" id="vo"}-->
						<!--<option value="{$vo.uid}">{$vo.real_name}</option>-->
						<!--{/volist}-->
					<!--</select>-->
					<input type="text" id="searchClick" placeholder="请输入极选师姓名">

					<!--<input class="btn-common" type="button" onclick="searchData()" value="搜索"/>-->
				</div>
			</td>
		</tr>
	</table>
	<table class="table-class">
		<colgroup>
			<col width="20%">
			<col width="20%">
			<col width="20%">
			<col width="20%">
			<col width="20%">
		</colgroup>
		<thead>
		<tr align="center">
			<th>极选师</th>
			<th align="center" data-field="order_number_count_no" class="goods-fields-sort">未出账订单统计(笔)<span class="desc"></span></th>
			<th align="center" data-field="order_fraction_sum_no" class="goods-fields-sort">未出账分润统计(元)<span class="desc"></span></th>
			<th align="center" data-field="order_number_count_yes" class="goods-fields-sort">已出账订单统计(笔)<span class="desc"></span></th>
			<th align="center" data-field="order_fraction_sum_yes" class="goods-fields-sort">已出账分润统计(元)<span class="desc"></span></th>
			<!--<th>操作</th>-->
			<input type="hidden" id="hidden_sort_rule"/>
		</tr>
		</thead>
		<tbody></tbody>
	</table>

	<div class="modal hide fade" id="checkout" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="left:32%;width:70%">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
					<h3>分润出账</h3>
				</div>
				<div class="modal-body">
					<!-- 主要内容 -->
					<div>待出账(<span id="order_num"></span>)，已选<span id="checkedbox">0</span></div>
					<table class="table table-hover" style="margin-bottom:10px;">
						<thead>
						<tr>
							<td>
								<label class="checkbox-inline">
									<input type="checkbox" id="inlineCheckbox1" onclick="checkoutCheckAll(this)">
								</label>
							</td>
							<td>订单号</td>
							<td>分润类型</td>
							<td>分润金额</td>
							<td>出账时间</td>
							<td>状态</td>
						</tr>
						</thead>
						<colgroup>
							<col style="width: 20%;">
							<col style="width: 20%;">
							<col style="width: 20%;">
							<col style="width: 20%;">
							<col style="width: 20%;">
						<colgroup>
						<tbody></tbody>
					</table>
				</div>

				<div class="modal-footer">
					<button class="btn btn-primary" onclick="checkoutSubmit()">确定出账</button>
					<button class="btn" data-dismiss="modal">关闭</button>
				</div>
			</div>
		</div>
	</div>
</div>
{/block}
{block name="script"}
<script type="text/javascript">
	$('#searchClick').keyup(function () {
		LoadingInfo(1);
	});

	$('#year').change(function () {
		LoadingInfo(1);
	});

	$('#month').change(function () {
		LoadingInfo(1);
	});

	function LoadingInfo(page_index) {
		var year = $("#year").val();
		var month = $("#month").val();
		var source_distribution = $("#source_distribution").val();
		var search_text = $('#searchClick').val();
		$.ajax({
			type : "post",
			url : "{:__URL('ADMIN_MAIN/Distributor/orderStatistics')}",
			data : {
				"page_index" : page_index,
				"page_size" : $("#showNumber").val(),
				"year" : year,
				"month" : month,
				"source_distribution" : source_distribution,
				'sort_rule': $("#hidden_sort_rule").val(),
				'search_text': search_text
			},
			success : function(data) {
				var html = '';
				if (data['list']["data"].length > 0) {
					for (var i = 0; i < data['list']["data"].length; i++) {
						html += '<tr align="center">';
						html += '<td>' + data['list']["data"][i]["real_name"]+ '</td>';
						html += '<td align="center">' + data['list']["data"][i]["order_number_count_no"]+ '</td>';
						html += '<td align="center" style="color:red">' + data['list']["data"][i]["order_fraction_sum_no"].toFixed(2)+ '</td>';
						html += '<td align="center">' + data['list']["data"][i]["order_number_count_yes"]+ '</td>';
						html += '<td align="center">' + data['list']["data"][i]["order_fraction_sum_yes"].toFixed(2)+ '</td>';
//						html += '<td><a style="cursor: pointer;" onclick="checkout('+data["start_date"]+','+data["end_date"]+','+data['list']["data"][i]["uid"]+')">出账</a>';
						html += '</tr>';
					}
				} else {
					html += '<tr align="center"><td colspan="7">暂无符合条件的数据</td></tr>';
				}
				$(".table-class tbody").html(html);
				initPageData(data['list']["page_count"],data['list']['data'].length,data['list']['total_count']);
				$("#pageNumber").html(pagenumShow(jumpNumber,$("#page_count").val(),{$pageshow}));
			}
		});
	}

	function checkout(start_date, end_date, uid){
		$("#checkout").modal('show');
		$("#checkout .modal-body table tbody tr").remove();
		$.ajax({
			type : "post",
			url : "{:__URL('ADMIN_MAIN/Distributor/distributorSeparationRecordsList')}",
			data : {
				'start_date':start_date,
				'end_date':end_date,
				'uid':uid
			},
			success : function(data) {
				var order_html = '';
				var order_num = 0;
				if (data.length > 0) {
					for (var i = 0; i < data.length; i++) {
						if (data[i]['is_checkout'] == 0) {
							order_num++;
						}
						order_html += '<tr>';
						if (data[i]['is_checkout'] == 1) {
							order_html += '<td><label class="checkbox-inline"><input type="checkbox" value="' + data[i]['is_checkout'] + '" disabled="true"></label></td>';
						} else {
							order_html += '<td><label class="checkbox-inline"><input type="checkbox" id="' + data[i]['id'] + '" value="' + data[i]['is_checkout'] + '" onclick="checkoutCheck(this)"></label></td>';
						}
						order_html += '<td>' + data[i]['order_no'] + '</td>';
						order_html += '<td>' + data[i]['text'] + '</td>';
						order_html += '<td>' + Number(data[i]['money']).toFixed(2) + '</td>';

						order_html += '<td>' + timeStampTurnTime(data[i]["checkout_time"]) + '</td>';
						if (data[i]['is_checkout'] == 0) {
							order_html += '<td style="color:red">未出账</td>';
						} else {
							order_html += '<td>已出账</td>';
						}

						order_html += '</tr>';
					}
				}else{
					order_html += '<tr align="center"><td colspan="6">暂无符合条件的数据</td></tr>';
				}
				$("#order_num").html(order_num);
				$("#checkout .modal-body table tbody").append(order_html);
			}
		});
	}

	function checkoutCheckAll(event){
		var checked = event.checked;
		$("#checkout .modal-body table tbody input[type = 'checkbox'][value = 0]").prop("checked",checked);
		var obj = $("#checkout .modal-body table tbody input[type = 'checkbox'][value = 0][checked]");
		$("#checkedbox").html(obj.length);
	}

	function checkoutCheck(event){
		var obj = $("#checkout .modal-body table tbody input[type = 'checkbox'][value = 0][checked]");
		$("#checkedbox").html(obj.length);
	}

	var flag = false;
	function checkoutSubmit(){
		var id_array = '';
		$("#checkout .modal-body table tbody input[type = 'checkbox'][value = 0][checked]").each(function(i){
			if(0==i){
				id_array = $(this).attr('id');
			}else{
				id_array += (","+$(this).attr('id'));
			}
		});
		if(id_array == ''){
			showTip("至少选择一笔分润",'warning');
			return false;
		}
		if(flag){
			return;
		}
		flag = true;
		$.ajax({
			type : "post",
			url : "{:__URL('ADMIN_MAIN/Distributor/checkoutSubmit')}",
			data : {'id_array':id_array},
			success : function(data) {
				$("#checkout").modal('hide');
				if (data['code'] > 0) {
					showMessage('success', data["message"],window.location.reload());
				} else {
					showMessage('error', data["message"]);
					flag = false;
				}
			}
		});
	}

	//排序规则
	$(".goods-fields-sort").click(function () {
		var field = $(this).attr("data-field");
		var sort_rule = $(this).attr("data-field");
		$(this).siblings().css("color", "#333333").find("span").removeClass("desc selected").addClass("desc");
		$(this).css("color", "#0072D2");
		if ($(this).find("span").hasClass("desc") && $(this).find("span").hasClass("selected")) {
			$(this).find("span").removeClass("desc").addClass("selected asc");
			sort_rule += ",a";
		} else if (($(this).find("span").hasClass("asc") && $(this).find("span").hasClass("selected")) || $(this).find("span").hasClass("desc")) {
			$(this).find("span").removeClass("asc").addClass("selected desc");
			sort_rule += ",d";
		}
		$("#hidden_sort_rule").val(sort_rule);
		LoadingInfo(1);
	});

</script>
{/block}