{extend name="adminblue/base" /}
{block name="resources"/}
<link rel="stylesheet" type="text/css" href="ADMIN_CSS/member_list.css" />
<style type="text/css">
	.num{
		width: 40px;
		text-align: center;
	}
	.text-p{
		width: 80%;
		margin-right: 20px;
	}
	.text-p>p{
		text-align: left;
	}
	#code_show{
		width: 200px;
		height: 200px;
		position: fixed;
		left: 45%;
		top: 30%;
		display: none
	}
</style>
{/block}
{block name="main"}
<div id="code_show"></div>
<table class="mytable">
	<tr>
		<th width="20%" style="text-align: left;">
			<!--<button class="btn-common-delete btn-small" onclick="batchDelete()" style="margin:0 5px 0 0 !important;">批量锁定</button>-->
			<button class="btn-common btn-small" onclick="location.href='{:__URL('ADMIN_MAIN/member/memberList?type=1')}';" style="margin:0 5px 0 0 !important;">添加极选师</button>
		</th>
		<th>
			<select id="source_branch" class="select-common">
				<option value="">请选择来源网点</option>
				<option value="0">--</option>
				{volist name="$storeList" id="vo"}
				<option value="{$vo.store_id}">{$vo.store_name}</option>
				{/volist}
			</select>
			<input type="text" id='search_text' placeholder="输入姓名/会员昵称/手机号" class="input-common" />
			<input type="button" onclick="searchData()" value="搜索" class="btn-common" />
			<input type="button" onclick="dataExcel()" value="导出数据" class="btn-common" />
			<!--<input class="btn-common" type="button" onclick="update()" value="更新数据"/>-->
		</th>
	</tr>
</table>
<table class="table-class">
	<colgroup>
		<col style="width: 20%;">
		<col style="width: 21%;">
		<col style="width: 10%;">
		<col style="width: 11%;">
		<col style="width: 10%;">
		<col style="width: 10%;">
		<col style="width: 10%;">
		<col style="width: 8%;">
	</colgroup>
	<thead>
		<tr align="center">
			<th>极选师</th>
			<th align="left">来源&类型&时间</th>
			<th align="left">人数(人)</th>
			<th align="left">账户余额(元)</th>
			<th align="right">累计成交订单(笔)</th>
			<th align="right">累计成交金额(元)</th>
			<th align="right">累计分润金额(元)</th>
			<th>操作</th>
		</tr>
	</thead>
	<tbody></tbody>
</table>
{/block}
{block name="script"}
<script type="text/javascript">
	function updateData() {
		$.ajax({
			type : "post",
			url : "{:__URL('ADMIN_MAIN/Distributor/updateData')}",
			data : {},
			success : function(data) {
				if (data['code'] > 0) {
					showMessage('success', data["message"]);
				} else {
					showMessage('error', data["message"]);
				}
			}
		});

	}

	function update() {
		$.ajax({
			type : "post",
			url : "{:__URL('ADMIN_MAIN/Member/update')}",
			data : {},
			success : function(data) {
				if (data['code'] > 0) {
					showMessage('success', data["message"]);
				} else {
					showMessage('error', data["message"]);
				}
			}
		});

	}

$('.num').live("change",function(){
	var fieldid = $(this).attr('fieldid');
	var sort = $(this).val();
	$.ajax({
		type:"post",
		url:"{:__URL('ADMIN_MAIN/cms/modifyarticlefield')}",
		data:{'fieldid':fieldid,'sort':sort},
		success: function (data) {
			if(data['code'] > 0){
				showTip("修改成功","success");
				LoadingInfo(getCurrentIndex(fieldid,'.table-class tbody'));
			}else{
				showTip("修改失败","error");
			}
		}
	});
});

function batchDelete() {
	var article_id= new Array();
	$(".table-class tbody input[type='checkbox']:checked").each(function() {
		if (!isNaN($(this).val())) {
			article_id.push($(this).val());
		}
	});
	if(article_id.length ==0){
		$( "#dialog" ).dialog({
			buttons: {
				"确定,#e57373": function() {
					$(this).dialog('close');
				}
			},
			contentText:"请选择需要操作的记录",
			title:"消息提醒",
		});
		return false;
	}
	deleteArticle(article_id);
}

$("body").click(function(){
	$("#code_show").hide();
	$('#code_img').remove();
});

//锁定
var flag = false;
function checkKolStatus(uid){
	$( "#dialog" ).dialog({
		buttons: {
			"确定": function() {
				$(this).dialog('close');
				if(!flag){
					flag = true;
					$.ajax({
						type : "post",
						url : "{:__URL('ADMIN_MAIN/kol/checkKolStatus')}",
						data : { "uid" : uid.toString() },
						dataType : "json",
						success : function(data) {
							if (data["code"] > 0) {
								showMessage('success', data["msg"]);
								LoadingInfo(getCurrentIndex(article_id,'.table-class tbody'));
							}else{
								showMessage('error', data["msg"]);
								flag = false;
							}
						}
					})
				}
			},
			"取消,#e57373": function() {
				$(this).dialog('close');
			}
		},
		contentText:"确定执行该操作？",
	});
}

//分页数据
function LoadingInfo(page_index) {
	var source_branch = $("#source_branch").val();
	var search_text = $("#search_text").val();
	$.ajax({
		type : "post",
		url : "{:__URL('ADMIN_MAIN/distributor/kolList')}",
		data : { "page_index" : page_index, "page_size" : $("#showNumber").val(), "source_branch" :source_branch, "search_text" : search_text },
		success : function(data) {
			var html = '';
			if (data["data"].length > 0) {
				for (var i = 0; i < data["data"].length; i++) {
//					var img = JSON.parse(data['data'][i].wx_info);
					html += '<tr align="center">';
					html += '<td align="left">';
					html += '<img src="'+__IMG(data["data"][i]["user_headimg"])+'" class="head-portrait" />';
					html += '<div style="float:left;">';
					html += '<label style="float:none;width:100%">姓名:<span>' + data["data"][i]["real_name"] + '</span></label>';
					html += '<label style="float:none;width:100%">昵称:<span>' + data["data"][i]["nick_name"] + '</span></label>';
					html += '<label style="float:none;width:100%">手机:<span>' + data["data"][i]["user_tel"] + '</span></label>';
					html += '<label style="float:none;width:100%">激活码:<span>' + data["data"][i]["activation_code"] + '</span></label>';
					html += '</div>';
					html += '</td>';
					html += '<td align="left">';
					if(data["data"][i]["source_distribution"]){
						html += '<p>推荐人:' + data["data"][i]["source_distribution_name"]+ '</p>';
					}
					if(data["data"][i]["inviter"]) {
						html += '<p>邀请人:' + data["data"][i]["inviter_name"] + '</p>';
					}
					if(data["data"][i]["source_branch"]) {
						html += '<p>来源网点:' + data["data"][i]["source_branch_name"] + '</p>';
					}
					html += '<p>分销类型:' + data["data"][i]["distributor_type_name"]+ '</p>';
					html += '<p>加入时间:' + timeStampTurnTime(data["data"][i]["create_time"])+ '</p>';
					html += '</td>';
					html += '<td align="left">';
					html += '<p>绑定会员:' + data["data"][i]["member_number_count"]+ '</p>';
					html += '<p>推荐极选师:' + data["data"][i]["recommender_number_count"]+ '</p>';
					html += '<p>邀请极选师:' + data["data"][i]["inviter_number_count"]+ '</p>';
					html += '</td>';
					html += '<td align="left"><p>分润:' + data["data"][i]["balance"]+ '</p><p>奖金:' + data["data"][i]["bonus"]+ '</p></td>';
					html += '<td align="right">' + data["data"][i]["order_number_count"]+ '</td>';
					html += '<td align="right">' + data["data"][i]["goods_money_sum"].toFixed(2)+ '</td>';
					html += '<td align="right">' + data["data"][i]["order_fraction_sum"].toFixed(2)+ '</td>';
//					html += '<td align="right">' + data["data"][i]["member_number_count"]+ '</td>';
//					html += data["data"][i]["status"] == 0 ? '<td style="color:red;">锁定</td>' : '<td style="color:green;">正常</td>';
					html += '<td>';
//					if(data["data"][i]["status"]==1){
//						html += '<a style="cursor: pointer;" onclick="lockkol('+data['data'][i]['uid']+')">设置锁定</a><br/>';
//					}else{
//						html += '<a style="cursor: pointer;" onclick="unlockkol('+data['data'][i]['uid']+')">设置解锁</a><br/>';
//					}
					html += '<a onclick="showCode('+data['data'][i]['uid']+')">小程序码</a><br/>';
					html += '<a href="'+__URL('ADMIN_MAIN/distributor/accountDetail?kol_id='+ data['data'][i]['uid'])+'">账户明细</a><br/>';
					html += '</td>';
					html += '</tr>';
				}
			} else {
				html += '<tr align="center"><td colspan="9">暂无极选师</td></tr>';
			}
			$(".table-class tbody").html(html);
			initPageData(data["page_count"],data['data'].length,data['total_count']);
			$("#pageNumber").html(pagenumShow(jumpNumber,$("#page_count").val(),{$pageshow}));
		}
	});
}

/**
 * 极选师数据导出
 */
function dataExcel(){
	var source_branch = $("#source_branch").val();
	var search_text = $("#search_text").val();
	window.location.href=__URL("ADMIN_MAIN/Distributor/kolDataExcel?source_branch="+source_branch+"&search_text="+search_text);
}

//锁定kol
function lockkol(uid){
	$.ajax({
		type : "post",
		url : "{:__URL('ADMIN_MAIN/Distributor/kollock')}",
		data : { "id" : uid },
		success : function(data) {
			if (data["code"] > 0) {
				LoadingInfo(getCurrentIndex(uid,'#productTbody'));
				showTip(data['message'],'success');
			}else{
				showTip(data['message'],'error');
			}
		}
	});
}

//解锁kol
function unlockkol(uid){
	$.ajax({
		type : "post",
		url : "{:__URL('ADMIN_MAIN/Distributor/kolunlock')}",
		data : { "id" : uid },
		success : function(data) {
			if (data["code"] > 0) {
				LoadingInfo(getCurrentIndex(uid,'#productTbody'));
				showTip(data['message'],'success');
			}else{
				showTip(data['message'],'error');
			}
		}
	});
}

//全选
function CheckAll(event){
	var checked = event.checked;
	$(".table-class tbody input[type = 'checkbox']").prop("checked",checked);
}

//搜索
function searchData(){
	LoadingInfo(1);
}

//小程序码
function showCode(uid){
	$.ajax({
		type : "post",
		url : "{:__URL('ADMIN_MAIN/Distributor/getWxCode')}",
		data : {
			"uid" : uid.toString()
		},
		dataType : "json",
		success : function(data) {
			if (data["code"] = 1) {
				$("#code_show").show();
				$("#code_show").append(
						'<image id="code_img" src="'+data.url+'">'
				);
			} else {

			}
		}
	})
}
</script>
{/block}