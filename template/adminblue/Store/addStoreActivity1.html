{extend name="adminblue/base" /}
{block name="resources"}
<script src="ADMIN_JS/My97DatePicker/WdatePicker.js" type="text/javascript"></script>

<style>
	#position_type label {
		float: left;
		margin-left: 150px
	}

	#blank_type label {
		float: left;
		margin-left: 200px
	}

	#bottom_div div {
		float: left;
		margin-left: 50px;
		cursor: pointer;
		padding: 5px 20px 5px 20px;
		border: 1px solid #000000
	}

	#show_div2:hover {
	}

	.label-inline-block {
		display: inline-block;
		margin: 0 15px 0 0;
		vertical-align: middle;
	}

	.set-style dl dd.goods-list {
		margin: 0;
		line-height: normal;
		width: 100%;
	}

	.combo-package-mask-layer {
		position: fixed;
		width: 100%;
		background: rgba(0, 0, 0, 0.7);
		height: 100%;
		left: 0;
		z-index: 3000;
		top: 0;
		display: none;
	}

	.goods-list-mask-layer {
		position: fixed;
		width: 800px;
		top: 20%;
		z-index: 3000;
		left: 50%;
		background: #ffffff;
		padding: 10px;
		border-radius: 5px;
		margin-left: -410px;
		display: none;
		overflow: auto;
		height: 84%;
		margin-bottom: 10%;
	}

	.goods-list-mask-layer table {
		width: 100%;
	}

	.table-class tr th {
		padding: 5px;
	}

	.table-class tr td {
		text-align: center;
	}

	.ns-main > #turn-ul {
		display: none !important;
	}

	.ini {
		color: #777;
		margin-left: 10px;
		font-size: 12px;
	}

	i.fa-times:hover {
		cursor: pointer;
	}

	.delete_data span:hover {
		cursor: pointer;
	}

	#float-div {
		position: fixed;
		right: 0;
		top: 60%;
		padding: 10px;
		border: 1px solid gray;
		background-color: white
	}

	#float-div div {
		cursor: pointer;
		padding: 10px 16px 10px 16px;
		text-align: center;
		border: 1px solid gray;
		margin: 10px;
		text-align: center;
	}
</style>
{/block}
{block name="main"}
<div class="set-style">


	<dl style="border-bottom: none;">
		<dt><span class="required">*</span>门店</dt>
		<dd>
			<select id="store_name">
				{foreach name="store_list" item="v"}
				<option value ="{$v.store_id}">{$v.store_name}</option>
				{/foreach}
			</select>

		</dd>
	</dl>

	<dl style="border-bottom: none;">
		<dt><span class="required">*</span>活动名称</dt>
		<dd>
			<input id="title" type="text" name="title" class="input-common" />
			<span class="error">请输入专题标题</span>
		</dd>
	</dl>


	<dl style="border-bottom: none;">
		<dt>封面图</dt>
		<dd>
			<div class="class-logo">
				<p>
					<img id="imglogo">
				</p>
			</div>
			<div class="upload-btn">
				<span>
					<input class="input-file" name="file_upload" id="uploadImg" type="file" onchange="imgUpload(this)">
					<input type="hidden" id="logo" />
				</span>
				<p><i class="fa fa-cloud-upload"></i>上传图片</p>
			</div>
		</dd>
	</dl>



	<dl>
		<dt><span style="color:red;">*</span>&nbsp;&nbsp;活动时间:</dt>
		<dd>
			<input class="input-medium input-common" autocomplete="off" type="text" id="start_time" style="width:250px;" onclick="WdatePicker({skin:'twoer',dateFmt:'yyyy-MM-dd HH:mm:ss'})" />
			<span class="mlr5">至</span>
			<input class="input-medium input-common" autocomplete="off" size="15"type="text" id="end_time" style="width:250px;" onclick="WdatePicker({skin:'twoer',dateFmt:'yyyy-MM-dd HH:mm:ss'})">
			<p class="error">请输入生效时间</p>
		</dd>
	</dl>



	<div style="margin:auto;width:30%;">
		<button class="btn-common" onclick="save(1)" style="float:left;margin-right:15px;">存为草稿</button>
		<button class="btn-common" onclick="save(2)" style="float:left;">发布专题</button>
	</div>

	<div id="float-div">
		<div id="show_div0">图片</div>
		<div id="show_div1">视频</div>
		<div id="show_div2">预约服务</div>
	</div>

	<div id="selecter"></div>
</div>

<script src="__STATIC__/js/ajax_file_upload.js" type="text/javascript"></script>
<script src="__STATIC__/js/file_upload.js" type="text/javascript"></script>
<script>
	$(document).on('blur','#goods_name',function() {
		goods_name = $($(this)).val();
	});

	$(document).on('blur','#material_code',function() {
		material_code = $($(this)).val();
	});
	function validation(){
		var title=$("#title");		//专题标题
		if(title.val() == ""){save(integral)
			title.next().css("display","inline-block");
			title.focus();
			return false;
		}
		return true;
	}
	var flag = false;//防止重复提交

	let allData = {
		pic: $("#logo").val(),
		title:$("#title").val(),
		is_show:$('#blank_type input[name="is_show"]:checked ').val(),
		items:[],
	}

	function save(type){
        if(type==1){
			var is_show=0;
		}else{
			var is_show=1;
		}

        allData['store_id']   = $("#store_name").val();
        allData['is_show'] 	  = is_show;
        allData['pic'] 		  = $("#logo").val();
        allData['title'] 	  = $("#title").val();
        allData['start_time'] = $("#start_time").val();
        allData['end_time']   = $("#end_time").val();

        if(!validation()){
			return;
		}
		if(flag){
			return;
		}
		flag = true;
		$.ajax({
			type:"post",
			url:"{:__URL('ADMIN_MAIN/store/addStoreActivity')}",
			data:allData,
			success:function(data){
				if (data["code"] > 0) {
					showMessage('success', data["message"]);
					location.href=__URL("ADMIN_MAIN/store/storeActivityLists");
				}else{
					showMessage('error', data["message"]);
					flag = false;
				}
			}
		});
	}



	//添加图片
	$(document).on('click','#show_div0',function(){
		var newId = allData.items.length;
		allData.items.push({
			id:newId,
            index_pic:'index_pic',
            pic_link:''
		});
		$("#selecter").append(
			'<div id="div0">'+
            '<dl style="height: 50px;background-color: #F5F6F5;margin-top: 60px;">'+
            '<dt style="font-size: 15px;color: black;font-weight: bold">'+'添加图片'+'</dt>'+
            '<dt class="delete_data" id="'+newId+'"><span>'+'删除'+'</span></dt>'+
            '</dl>'+
            '<dl style="border-bottom: none;">'+
            '<dt>'+'详情图片'+'</dt>'+
            '<dd>'+
            '<div class="class-logo">'+
            '<p>'+
            '<img class="imglogo1">'+
            '</p>'+
            '</div>'+
            '<div class="upload-btn">'+
            '<span>'+
            '<input class="input-file" name="file_upload" id="test'+newId+'" data-id='+newId+' type="file" onchange="imgUpload1(this)">'+
            '<input type="hidden" id="'+newId+'"/>'+
            '</span>'+
            '<p>'+'<i class="fa fa-cloud-upload">'+'</i>'+'上传图片'+'</p>'+
            '</div>'+
            '<p class="hint">'+
            '<br>'+'<span style="color: orange;">'+'建议使用宽1200像素-高300像素内的GIF或PNG透明图片;'+'</span>'+
            '</p>'+
            '</dd>'+
            '</dl>'+

            '<dl style="border-bottom: none;">'+
            '<dt>'+'链接'+'</dt>'+
            '<dd>'+
            '<div style="float: left">'+
            '<select  class="select-common pic_link" data-id='+newId+' name="pic_link">'+
            '<option value="无链接">'+'无链接'+'</option>'+
            '<option value="主页">'+'主页'+'</option>'+
            '<option value="全部商品">'+'全部商品'+'</option>'+
            '<option value="礼品专区">'+'礼品专区'+'</option>'+
            '<option value="会员专区">'+'会员专区'+'</option>'+
            '<option value="商品详情页">'+'商品详情页'+'</option>'+
            '<option value="options_value">'+'小程序路径'+'</option>'+
            '</select>'+
            '</div>'+
            '<div style="float: left;margin-left: 20px">'+
            '<div class="option4" style="display:none">'+
            '<input type="text" class="pic_link" name="pic_link" data-id='+newId+' placeholder="请输入小程序路径,如/pages/index/index" >'+
            '</div>'+
            '<div class="option4" style="display:none">'+
            '<input type="number" class="pic_link" name="pic_link" data-id='+newId+' placeholder="请输入详情页id,如12" >'+
            '</div>'+
            '</div>'+
            // '<dt>'+'排序'+'</dt>'+
            // '<dd>'+'<input  type="number" name="sort" data-id='+newId+' min="0" class="input-common sort" />'+'</dd>'+
            '</dd>'+
            '</dl>'+
			'</div>'
		)
	});
	//		end





	$(document).on('click','#show_div1',function(){
		var newId = allData.items.length;
		allData.items.push({
			id : newId,
            index_video : '',
            video_pic : ''
		});
		$("#selecter").append(
			'<div id="div1">'+
            '<dl style="height: 50px;background-color: #F5F6F5;border-bottom: none">'+
            '<dt style="font-size: 15px;color: black;font-weight: bold">'+'添加视频'+'</dt>'+
            '<dt class="delete_data" id="'+newId+'"><span>'+'删除'+'</span></dt>'+
            '</dl>'+

            '<dl style="border-bottom: none;">'+
            '<dl>'+
            '<dd style="margin-left: 10%">'+
            '<div class="controls" style="background-color:#FFF;border: 1px solid #E9E9E9;">'+
            '<div class="ncsc-goods-default-pic">'+
            '<div class="goodspic-uplaod" style="padding: 15px;">'+
            '<div style="min-height:120px;">'+
            '<div class="video-thumb" >'+
            '<video id="my-video'+newId+'" controls poster="__STATIC__/blue/img/vs.png" preload="auto"  style="max-width:50%;max-height:100%;width:auto;height:auto;">'+
            '<source src="" type="video/mp4" id="video-source">'+
            '</video>'+
            '<span class="del-video hide" data-id='+newId+' onclick="del_video(this)"></span>'+
            '</div>'+
            '</div>'+
            '<div class="clear"></div>'+
            '<div class="handle">'+
            '<div class="ncsc-upload-btn">'+
            '<a href="javascript:void(0);">'+
            '<span>'+
            '<input class="input-file video-file" name="file_upload" id="test'+newId+'" data-id='+newId+' type="file" onchange="fileUpload_video(this);"  value="">'+
            '</span>'+
            '<p>视频上传</p>'+
            '<input type="hidden" class="video-file" id="video_url'+newId+'" value="">'+
            '</a>'+
            '</div>'+
            '</div>'+
            '</div>'+
            '</div>'+
            '</div>'+
            '</dd>'+
            '</dl>'+
            '</dl>'+

            '<dl style="border-bottom: none;">'+
            '<dt>'+'视频封面'+'</dt>'+
            '<dd>'+
            '<div class="class-logo">'+
            '<p>'+
            '<img class="imglogo1">'+
            '</p>'+
            '</div>'+
            '<div class="upload-btn">'+
            '<span>'+
            '<input class="input-file" name="file_upload" id="test1'+newId+'" data-id='+newId+' type="file" onchange="imgUpload2(this)">'+
            '<input type="hidden" id="'+newId+'"/>'+
            '</span>'+
            '<p>'+'<i class="fa fa-cloud-upload">'+'</i>'+'上传图片'+'</p>'+
            '</div>'+
            '<p class="hint">'+
            '<br>'+'<span style="color: orange;">'+'建议使用宽1200像素-高300像素内的GIF或PNG透明图片;'+'</span>'+
            '</p>'+
            '</dd>'+
            '</dl>'+

            // '<dl style="border-bottom: none;">'+
            // '<dt>'+'<span style="color:red;margin-left:15px;">'+'</span>'+'是否显示'+'</dt>'+
            // '<dd>'+
            // '<div id="position_type">'+
            // '<label for="navigationtype1" class="line-label"><input type="radio" value="1" data-id='+newId+' class="movie_show" name="movie_show'+newId+'" id="navigationtype1" checked="checked"/>'+' 显示'+'</label>'+
            // '<label for="navigationtype2" class="line-label"><input type="radio" value="0" data-id='+newId+' class="movie_show" name="movie_show'+newId+'" id="navigationtype2"/>'+' 隐藏'+'</label>'+
            // '</div>'+
            // '</dd>'+
            // '</dl>'+
            // '<dl>'+
            // '<dt>'+'排序'+'</dt>'+
            // '<dd>'+'<input  type="number" name="sort" data-id='+newId+' min="0" class="input-common sort" />'+'</dd>'+
            // '<dd>'+

            '</dl>'+
			'</div>'
		)
	});



	$(document).on('click','.delete_data',function(){
		var data = allData.items;
		var index = $(this).attr('id') - 1;
		data.splice(index, 1);
		$($(this)).parent().parent().remove();
	});


	$(document).on('blur','.input-file',function(){
		var pic = $(this).next('input').val();
		formatData($(this).data('id'),pic,'index_pic');
	});

	$(document).on('blur','.pic_link',function(){
		var pic_link = $(this).val();
		formatData($(this).data('id'),pic_link,'pic_link');
	});


	$(document).on('blur','.content',function(){
		var content = $(this).val();
		formatData($(this).data('id'),content,'content');
	});


	$(document).on('blur','.user_num',function(){
		var user_num = $(this).val();
		formatData($(this).data('id'),user_num,'user_num');
	});



	function formatData (index,val,type) {
		allData.items.forEach(v => {
			if(v.id == index)
			{
				v[type] = val;
			}
			return v;
		});
	}


	$(document).on('click','#show_div2',function(){
		var newId = allData.items.length;
		allData.items.push({
			id:newId,
            appointment_pic:'',
            start_time:'',
            end_time:'',
            user_num:'',
            coupon_pic:''
		});
		$("#selecter").append(
			'<div id="div2">'+
            '<dl style="height: 50px;background-color: #F5F6F5;margin-top: 60px;">'+
            '<dt style="font-size: 15px;color: black;font-weight: bold">'+'预约服务'+'</dt>'+
            '<dt class="delete_data" id="'+newId+'"><span>'+'删除'+'</span></dt>'+
            '</dl>'+
            '<dl style="border-bottom: none;">'+
            '<dt>'+'预约图片'+'</dt>'+
            '<dd>'+
            '<div class="class-logo">'+
            '<p>'+
            '<img class="imglogo1">'+
            '</p>'+
            '</div>'+
            '<div class="upload-btn">'+
            '<span>'+
            '<input class="input-file" name="file_upload" id="test2'+newId+'" data-id='+newId+' type="file" onchange="imgUpload3(this)">'+
            '<input type="hidden" id="'+newId+'"/>'+
            '</span>'+
            '<p>'+'<i class="fa fa-cloud-upload">'+'</i>'+'上传图片'+'</p>'+
            '</div>'+
            '<p class="hint">'+
            '<br>'+'<span style="color: orange;">'+'建议使用宽1200像素-高300像素内的GIF或PNG透明图片;'+'</span>'+
            '</p>'+
            '</dd>'+
            '</dl>'+

            // '<dl>'+
            // '<dt><span style="color:red;">*</span>&nbsp;&nbsp;活动时间:</dt>'+
            // '<dd>'+
            // '<input class="input-medium input-common" autocomplete="off" type="text" id="start_time" style="width:250px;" onclick="WdatePicker({skin:"twoer",dateFmt:"yyyy-MM-dd HH:mm:ss"})" />'+
        	// '<span class="mlr5">至</span>'+
        	// '<input class="input-medium input-common" autocomplete="off" size="15" type="text" id="end_time" style="width:250px;" onclick="WdatePicker({skin:"twoer",dateFmt:"yyyy-MM-dd HH:mm:ss"})">'+
        	// '<p class="error">请输入生效时间</p>'+
        	// '</dd>'+
        	// '</dl>'+

			'<dl>'+
			'<dt>'+'预约名额'+'</dt>'+
			'<dd>'+'<input  type="number" name="user_num" data-id='+newId+' min="0" class="input-common user_num"  style="width: 50px"/> <span>人</span>'+'</dd>'+
			'</dd>'+
			'</dl>'+

			'<dl style="border-bottom: none;">'+
			'<dt>'+'电子券面'+'</dt>'+
			'<dd>'+
			'<div class="class-logo">'+
			'<p>'+
			'<img class="imglogo1">'+
			'</p>'+
			'</div>'+
			'<div class="upload-btn">'+
			'<span>'+
			'<input class="input-file" name="file_upload" id="test3'+newId+'" data-id='+newId+' type="file" onchange="imgUpload4(this)">'+
			'<input type="hidden" id="'+newId+'"/>'+
			'</span>'+
			'<p>'+'<i class="fa fa-cloud-upload">'+'</i>'+'上传图片'+'</p>'+
			'</div>'+
			'<p class="hint">'+
			'<br>'+'<span style="color: orange;">'+'建议使用宽1200像素-高300像素内的GIF或PNG透明图片;'+'</span>'+
			'</p>'+
			'</dd>'+
			'</dl>'+

			'</div>'
		);
	});



	//新增 js
	var BatchSend = new Array();
	$(function(){
		if($("#goods_id_array").val()){
			if($("#goods_id_array").val().length > 0){
				BatchSend = $("#goods_id_array").val().split(",");
			}
			refreshSelectGoods();
		}
	});

	$(document).on('click','.js-select-goods',function(){
		goods_name = '';
		material_code = '';
		$(".input-common-goods").attr("value","");
		LoadingInfo(1);
		modal("show");
	});

	//点击遮罩隐藏商品选择框
	$(document).on('click','.combo-package-mask-layer',function(){
		modal("hide");
	});

	//全选
	function CheckAll(obj){
		var checked = obj.checked;
		$(".table-class tbody tr input:checkbox").prop("checked",checked);
	}

	function LoadingInfo(page_index) {
		var _goods_name = goods_name;
		var _material_code = material_code;
		if(typeof(_goods_name) == 'object'){
			var _goods_name = $('#goods_name').val();
		}
		if(typeof(_material_code) == 'object'){
			var _material_code = $('#material_code').val();
		}
		$.ajax({
			type : "post",
			url : "{:__URL('ADMIN_MAIN/goods/getSelectGoodslist')}",
			data : {
				"page_index" : page_index,
				"page_size" : $("#showNumber").val(),
				"goods_name":_goods_name,
				"material_code":_material_code,
				"type" : "select"
			},
			success : function(data) {
				var html = '';
				if (data["data"].length > 0) {
					for (var i = 0; i < data["data"].length; i++) {

						html += '<tr>';
						html += '<td>';
						html += '<input value="' + data["data"][i]["goods_id"] + '" name="sub" data-state="'+data["data"][i]["state"]+'" type="radio">';
						html += '</td>';

						html += '<td style="text-align:left;">' + data["data"][i]["goods_name"] + '</td>';

						html += '<td>' + data["data"][i]["material_code"] + '</td>';

						html += '<td>' + data["data"][i]["price"] + '</td>';

						html += '<td>' + data["data"][i]["stock"]  + '</td>';

						html += '</tr>';
					}
				} else {
					html += '<tr align="center"><td colspan="9" style="text-align: center;font-weight: normal;color: #999;">暂无符合条件的数据记录</td></tr>';
				}
				$(".goods-list-mask-layer .table-class tbody").html(html);
				initPageData(data["page_count"],data['data'].length,data['total_count']);
				$("#pageNumber").html(pagenumShow(jumpNumber,$("#page_count").val(),{$pageshow}));
				if($(".goods-list-mask-layer #turn-ul").length == 0){
					$(".goods-list-mask-layer").append($("#turn-ul").clone(true).show());
				}
				$(".ns-main>#turn-ul").remove();
			}
		});
	}
	//点击确定
	$(document).on('click','#determine',function(){
		$('#goods_id_array').val($("input[name='sub']:checked").val());
		formatData($(this).data('id'),$("#goods_id_array").val(),'pid');
		var id = $("input[name='sub']:checked").val();
		var index = $(this).data('id');
		var dom = $(this);
		if(id > 0){
			$.ajax({
				type : "post",
				url : "{:__URL('ADMIN_MAIN/goods/getGoodsFieldInfo')}",
				data : {
					"id" : id
				},
				async : false,
				success : function(data) {
					formatData(index,data['goods_name'],'goods_name');
					formatData(index,data['material_code'],'material_code');
					formatData(index,data['price'],'price');
					formatData(index,data['stock'],'stock');
				}
			})
		}
		refreshSelectGoods(index , dom);
		modal("hide");
	});


	//模态框隐藏显示
	function modal(type){
		if(type == "show"){
			$(".combo-package-mask-layer").show();
			$(".goods-list-mask-layer").show();
		}else if(type == "hide"){
			$(".combo-package-mask-layer").hide();
			$(".goods-list-mask-layer").hide();
		}
	}

	//商品取消选择
	function cancelSelect(index){
		allData['items'][index]['pid'] = '';
		allData['items'][index]['goods_name'] = '';
		allData['items'][index]['material_code'] = '';
		allData['items'][index]['stock'] = '';
		refreshSelectGoods();
	}

	//刷新选择的商品
	function refreshSelectGoods(index , dom){
		if(typeof(allData['items'][index]) != 'undefined'){
			var goods_id_array = $("#goods_id_array").val();
			var html = '';

			html += '<tr>';
			html += '<input value="' + allData['items'][index]["pid"] + '"  type="hidden">';

			html += '<td>' + allData['items'][index]["goods_name"] + '</td>';

			html += '<td>' + allData['items'][index]["material_code"] + '</td>';

			html += '<td class="goods_price">' + allData['items'][index]["price"] + '</td>';

			html += '<td>' + allData['items'][index]["stock"]  + '</td>';

			html += '<td><label for=""><i class="fa fa-times" aria-hidden="true fa-2x" onclick="cancelSelect('+index+')"></i></label></td>';

			html += '</tr>';

			$(dom).parent().prev().prev().children().children().children('tbody:last-child').html(html);
		}else{
			$(".goods-list .table-class tbody").html("");

		}
		calculate_original_price(); //计算原价
	}

	//价格
	$("#combo_package_price").change(function(){
		var price = parseFloat(parseFloat($(this).val()).toFixed(2));
		var original_price = parseFloat(parseFloat($("#original_price").text()).toFixed(2)); //原价
		if(price < 0){
			price = 0;
		}else if(price > original_price){
			price = original_price;
		}
		$(this).val(price);
		calculate_original_price();
	})

	//重置
	function click_reset(){
		BatchSend = Array();
		$("#goods_id_array").val("");
		$(".goods-list .table-class tbody").html("");
	}

	function calculate_original_price(){
		var original_price = 0;
		$(".goods-list .table-class tbody tr td.goods_price").each(function(i,e){
			var price = parseFloat($(e).text());
			original_price += price;
		})
		var combo_package_price = parseFloat($("#combo_package_price").val());
		$("#original_price").text(original_price.toFixed(2)); //原价
		if(combo_package_price > 0){
			if(combo_package_price > original_price){
				combo_package_price = original_price;
				$("#combo_package_price").val(combo_package_price);
			}
			$("#save_the_price").text((original_price - combo_package_price).toFixed(2)); //节省价
		}
	}

    //图片上传
    function imgUpload(event) {
        var fileid = $(event).attr("id");

        var imgDom = $(event).parent().parent().prev().children().children();
        var data = { 'file_path' : UPLOADCOMMON };
        uploadFile(fileid,data,function(res){
            if(res.code){
                imgDom.attr("src",__IMG(res.data));
                $("#logo").val(res.data);
                showTip(res.message,"success");
            }else{
                showTip(res.message,"error");
            }
        });
    }

    //图片上传
    function imgUpload1(event) {
        var fileid 	= $(event).attr("id");
        var id 		= $(event).data('id');
        var imgDom 	= $(event).parent().parent().prev().children().children();
        var data	= { 'file_path' : UPLOADCOMMON };

        uploadFile(fileid,data,function(res){
            if(res.code){
                imgDom.attr("src",__IMG(res.data));
                $(event).next().val(res.data);
                formatData(id,res.data,'index_pic');
                showTip(res.message,"success");
            }else{
                showTip(res.message,"error");
            }
        });
    }

    function imgUpload2(event) {
        var fileid 	= $(event).attr("id");
        var id 		= $(event).data('id');
        var imgDom 	= $(event).parent().parent().prev().children().children();
        var data	= { 'file_path' : UPLOADCOMMON };

        uploadFile(fileid,data,function(res){
            if(res.code){
                imgDom.attr("src",__IMG(res.data));
                $(event).next().val(res.data);
                formatData(id,res.data,'video_pic');
                showTip(res.message,"success");
            }else{
                showTip(res.message,"error");
            }
        });
    }

    function imgUpload3(event) {
        var fileid 	= $(event).attr("id");
        var id 		= $(event).data('id');
        var imgDom 	= $(event).parent().parent().prev().children().children();
        var data	= { 'file_path' : UPLOADCOMMON };

        uploadFile(fileid,data,function(res){
            if(res.code){
                imgDom.attr("src",__IMG(res.data));
                $(event).next().val(res.data);
                formatData(id,res.data,'appointment_pic');
                showTip(res.message,"success");
            }else{
                showTip(res.message,"error");
            }
        });
    }



    function imgUpload4(event) {
        var fileid 	= $(event).attr("id");
        var id 		= $(event).data('id');
        var imgDom 	= $(event).parent().parent().prev().children().children();
        var data	= { 'file_path' : UPLOADCOMMON };

        uploadFile(fileid,data,function(res){
            if(res.code){
                imgDom.attr("src",__IMG(res.data));
                $(event).next().val(res.data);
                formatData(id,res.data,'coupon_pic');
                showTip(res.message,"success");
            }else{
                showTip(res.message,"error");
            }
        });
    }

	/**
	 * 文件上传（视频、音频）
	 */
	function fileUpload_video(event) {
		var fileid = $(event).attr("id");
        var id = $(event).data('id');
        var data_id = $(event).attr("data-id");
		var data = { 'file_path' : UPLOADGOODSVIDEO };
		var dom = document.getElementById(fileid);
		var file = dom.files[0];//File对象;
		var fileTypeArr = ['video/mp4', 'video/3gp', 'video/avi', 'video/rmvb', 'video/rm'];
		var flag = false;
		if (file != null) {
			for (var i = 0; i < fileTypeArr.length; i++) {
				if (file.type == fileTypeArr[i]) {
					flag = true;
					break;
				}
			}
		}
		if (!flag) {
			showTip("文件类型不合法", "warning");
		} else {
			uploadFile(fileid, data, function (res) {
				if (res.code) {
					$("#video_url"+data_id).val(res['data']);
					$("#my-video"+data_id).attr('poster','');
					$("#my-video"+data_id).attr('src',__IMG(res['data']));
                    formatData(id,res.data,'movie_link');
                    $(".del-video").show();
					showTip(res.message, "success");
				} else {
					showTip(res.message, "error");
				}
			});
		}
	}


	/**
	 * 删除已选择的视频
	 */
	function del_video(event) {
		// 通过ajax用php删除文件
		var data_id = $(event).attr("data-id");
		var src 	= $("#video_url"+data_id).val();
		if (src != "") {
			$("#my-video"+data_id).attr('src', "");
			$("#my-video"+data_id).attr('poster', '__STATIC__/blue/img/vs.png');
			$("#videoupload").val('');
			$(".del-video").hide();
			$("#video_url"+data_id).val('');
		}
	}


</script>


{/block}


