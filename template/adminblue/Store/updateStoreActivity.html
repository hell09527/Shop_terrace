{extend name="adminblue/base" /}
{block name="resources"}
<style>
	#position_type label {
		float: left;
		margin-left: 150px
	}

	#blank_type label {
		float: left;
		margin-left: 200px
	}

	#bottom_div div {
		float: left;
		margin-left: 50px;
		cursor: pointer;
		padding: 5px 20px 5px 20px;
		border: 1px solid #000000
	}

	.label-inline-block {
		display: inline-block;
		margin: 0 15px 0 0;
		vertical-align: middle;
	}

	.set-style dl dd.goods-list {
		margin: 0;
		line-height: normal;
		width: 100%;
	}

	.combo-package-mask-layer {
		position: fixed;
		width: 100%;
		background: rgba(0, 0, 0, 0.7);
		height: 100%;
		left: 0;
		z-index: 3000;
		top: 0;
		display: none;
	}

	.goods-list-mask-layer {
		position: fixed;
		width: 800px;
		top: 20%;
		z-index: 3000;
		left: 50%;
		background: #ffffff;
		padding: 10px;
		border-radius: 5px;
		margin-left: -410px;
		display: none;
		overflow: auto;
		height: 84%;
		margin-bottom: 10%;
	}

	.goods-list-mask-layer table {
		width: 100%;
	}

	.table-class tr th {
		padding: 5px;
	}

	.table-class tr td {
		text-align: center;
	}

	.ns-main > #turn-ul {
		display: none !important;
	}

	.ini {
		color: #777;
		margin-left: 10px;
		font-size: 12px;
	}

	i.fa-times:hover {
		cursor: pointer;
	}

	.delete_data span:hover {
		cursor: pointer;
	}

	#float-div {
		position: fixed;
		right: 0;
		top: 60%;
		padding: 10px;
		border: 1px solid gray;
		background-color: white
	}

	#float-div div {
		cursor: pointer;
		padding: 10px 16px 10px 16px;
		text-align: center;
		border: 1px solid gray;
		margin: 10px;
		text-align: center;
	}

</style>

{/block}
{block name="main"}
<div class="set-style">
	<dl>
		<dt><span class="required">*</span>门店活动</dt>
		<dd>
			<input id="title" class="input-common" type="text" value="{$info.activity_name}"/>
			<span class="error">请输入活动标题</span>
		</dd>
	</dl>
	<dl>
		<dt>专题封面</dt>
		<dd>
			<div class="class-logo">
				<p>
					{if condition="$info.pic eq ''"}
					<img id="imglogo">
					{else/}
					<img id="imglogo" src="{:__IMG($info.pic)}">
					{/if}
				</p>
			</div>
			<div class="upload-btn">
				<span>
					<input class="input-file" name="file_upload" id="uploadImg" type="file" onchange="imgUpload(this);">
					<input type="hidden" id="logo" value="{$info.pic}"/>
				</span>
				<p><i class="fa fa-cloud-upload"></i>上传图片</p>
			</div>
		</dd>
	</dl>

	<div style="margin:auto;width:30%;">
		<button class="btn-common" onclick="save(1)" style="float:left;margin-right:15px;">存为草稿</button>
		<button class="btn-common" onclick="save(2)" style="float:left;">发布专题</button>
	</div>


	<div id="float-div">
		<div id="show_div0">图片</div>
		<div id="show_div1">视频</div>
		<div id="show_div2">预约服务</div>
	</div>

	<div id="div_home"></div>


</div>
<script src="__STATIC__/js/ajax_file_upload.js" type="text/javascript"></script>
<script src="__STATIC__/js/file_upload.js" type="text/javascript"></script>
<script>
	var allData = {$info};
	var data = allData.items;

    $(document).on('blur','#goods_name',function() {
		goods_name = $($(this)).val();
	});

	$(document).on('blur','#material_code',function() {
		material_code = $($(this)).val();
	});

	for (var i = 0; i < data.length; i ++) {

        console.log(data[i]);
        if (data[i].index_pic){
			$("#div_home").append(
                '<div id="div0">'+
                '<dl style="height: 50px;background-color: #F5F6F5;margin-top: 60px;">'+
                '<dt style="font-size: 15px;color: black;font-weight: bold">'+'添加图片'+'</dt>'+
                '<dt class="delete_data" id="'+i+'"><span>'+'删除'+'</span></dt>'+
                '</dl>'+
                '<dl style="border-bottom: none;">'+
                '<dt>'+'详情图片'+'</dt>'+
                '<dd>'+
                '<div class="class-logo">'+
                '<p>'+
                {if condition="$data[i].index_pic eq ''"}
				'<img id="imglogo1">'+
				{else/}
                '<img id="imglogo1" src="'+data[i].index_pic+'">'+
				{/if}
                '</p>'+
                '</div>'+
                '<div class="upload-btn">'+
                '<span>'+
                '<input class="input-file" name="file_upload" id="test'+i+'" data-id='+i+' type="file" onchange="imgUpload1(this)">'+
                '<input type="hidden" id="'+i+'"/>'+
                '</span>'+
                '<p>'+'<i class="fa fa-cloud-upload">'+'</i>'+'上传图片'+'</p>'+
                '</div>'+
                '<p class="hint">'+
                '<br>'+'<span style="color: orange;">'+'建议使用宽1200像素-高300像素内的GIF或PNG透明图片;'+'</span>'+
                '</p>'+
                '</dd>'+
                '</dl>'+

                '<dl style="border-bottom: none;">'+
                '<dt>'+'链接'+'</dt>'+
                '<dd>'+
                '<div style="float: left">'+
                '<select  class="select-common pic_link" data-id='+i+' name="pic_link">'+
                '<option value="无链接">'+'无链接'+'</option>'+
                '<option value="主页">'+'主页'+'</option>'+
                '<option value="全部商品">'+'全部商品'+'</option>'+
                '<option value="礼品专区">'+'礼品专区'+'</option>'+
                '<option value="会员专区">'+'会员专区'+'</option>'+
                '<option value="商品详情页">'+'商品详情页'+'</option>'+
                '<option value="options_value">'+'小程序路径'+'</option>'+
                '</select>'+
                '</div>'+
                '<div style="float: left;margin-left: 20px">'+
                '<div class="option4" style="display:none">'+
                '<input type="text" class="pic_link" name="pic_link" data-id='+i+' placeholder="请输入小程序路径,如/pages/index/index" >'+
                '</div>'+
                '<div class="option4" style="display:none">'+
                '<input type="number" class="pic_link" name="pic_link" data-id='+i+' placeholder="请输入详情页id,如12" >'+
                '</div>'+
                '</div>'+
                // '<dt>'+'排序'+'</dt>'+
                // '<dd>'+'<input  type="number" name="sort" data-id='+i+' min="0" class="input-common sort" />'+'</dd>'+
                '</dd>'+
                '</dl>'+
                '</div>'
				);
		}else if (data[i].index_video){
			$("#div_home").append(
                '<div id="div1">'+
                '<dl style="height: 50px;background-color: #F5F6F5;border-bottom: none">'+
                '<dt style="font-size: 15px;color: black;font-weight: bold">'+'添加视频'+'</dt>'+
                '<dt class="delete_data" id="'+i+'"><span>'+'删除'+'</span></dt>'+
                '</dl>'+

                '<dl style="border-bottom: none;">'+
                '<dl>'+
                '<dd style="margin-left: 10%">'+
                '<div class="controls" style="background-color:#FFF;border: 1px solid #E9E9E9;">'+
                '<div class="ncsc-goods-default-pic">'+
                '<div class="goodspic-uplaod" style="padding: 15px;">'+
                '<div style="min-height:120px;">'+
                '<div class="video-thumb" >'+
                '<video id="my-video'+i+'" controls poster="__STATIC__/blue/img/vs.png" preload="auto"  style="max-width:50%;max-height:100%;width:auto;height:auto;">'+
                '<source src="" type="video/mp4" id="video-source">'+
                '</video>'+
                '<span class="del-video hide" data-id='+i+' onclick="del_video(this)"></span>'+
                '</div>'+
                '</div>'+
                '<div class="clear"></div>'+
                '<div class="handle">'+
                '<div class="ncsc-upload-btn">'+
                '<a href="javascript:void(0);">'+
                '<span>'+
                '<input class="input-file video-file" name="file_upload" id="test'+i+'" data-id='+i+' type="file" onchange="fileUpload_video(this);"  value="">'+
                '</span>'+
                '<p>视频上传</p>'+
                '<input type="hidden" class="video-file" id="video_url'+i+'" value="">'+
                '</a>'+
                '</div>'+
                '</div>'+
                '</div>'+
                '</div>'+
                '</div>'+
                '</dd>'+
                '</dl>'+
                '</dl>'+

                '<dl style="border-bottom: none;">'+
                '<dt>'+'视频封面'+'</dt>'+
                '<dd>'+
                '<div class="class-logo">'+
                '<p>'+
                {if condition="$data[i].video_pic eq ''"}
				'<img id="imglogo1">'+
				{else/}
                '<img id="imglogo1" src="'+data[i].video_pic+'">'+
                {/if}
                '</p>'+
                '</div>'+
                '<div class="upload-btn">'+
                '<span>'+
                '<input class="input-file" name="file_upload" id="test1'+i+'" data-id='+i+' type="file" onchange="imgUpload2(this)">'+
                '<input type="hidden" id="'+i+'"/>'+
                '</span>'+
                '<p>'+'<i class="fa fa-cloud-upload">'+'</i>'+'上传图片'+'</p>'+
                '</div>'+
                '<p class="hint">'+
                '<br>'+'<span style="color: orange;">'+'建议使用宽1200像素-高300像素内的GIF或PNG透明图片;'+'</span>'+
                '</p>'+
                '</dd>'+
                '</dl>'+

                // '<dl style="border-bottom: none;">'+
                // '<dt>'+'<span style="color:red;margin-left:15px;">'+'</span>'+'是否显示'+'</dt>'+
                // '<dd>'+
                // '<div id="position_type">'+
                // '<label for="navigationtype1" class="line-label"><input type="radio" value="1" data-id='+i+' class="movie_show" name="movie_show'+i+'" id="navigationtype1" checked="checked"/>'+' 显示'+'</label>'+
                // '<label for="navigationtype2" class="line-label"><input type="radio" value="0" data-id='+i+' class="movie_show" name="movie_show'+i+'" id="navigationtype2"/>'+' 隐藏'+'</label>'+
                // '</div>'+
                // '</dd>'+
                // '</dl>'+
                // '<dl>'+
                // '<dt>'+'排序'+'</dt>'+
                // '<dd>'+'<input  type="number" name="sort" data-id='+i+' min="0" class="input-common sort" />'+'</dd>'+
                // '<dd>'+

                '</dl>'+
                '</div>'
			);
		} else {
            $("#div_home").append(
                '<div id="div2">'+
                '<dl style="height: 50px;background-color: #F5F6F5;margin-top: 60px;">'+
                '<dt style="font-size: 15px;color: black;font-weight: bold">'+'预约服务'+'</dt>'+
                '<dt class="delete_data" id="test1'+i+'"><span>'+'删除'+'</span></dt>'+
                '</dl>'+
                '<dl style="border-bottom: none;">'+
                '<dt>'+'预约图片'+'</dt>'+
                '<dd>'+
                '<div class="class-logo">'+
                '<p>'+
                {if condition="$data[i].appointment_pic eq ''"}
				'<img id="imglogo1">'+
				{else/}
                '<img id="imglogo1" src="'+data[i].appointment_pic+'">'+
				{/if}
                '</p>'+
                '</div>'+
                '<div class="upload-btn">'+
                '<span>'+
                '<input class="input-file" name="file_upload" id="test2'+i+'" data-id='+i+' type="file" onchange="imgUpload3(this)">'+
                '<input type="hidden" id="'+i+'"/>'+
                '</span>'+
                '<p>'+'<i class="fa fa-cloud-upload">'+'</i>'+'上传图片'+'</p>'+
                '</div>'+
                '<p class="hint">'+
                '<br>'+'<span style="color: orange;">'+'建议使用宽1200像素-高300像素内的GIF或PNG透明图片;'+'</span>'+
                '</p>'+
                '</dd>'+
                '</dl>'+

                // '<dl>'+
                // '<dt><span style="color:red;">*</span>&nbsp;&nbsp;活动时间:</dt>'+
                // '<dd>'+
                // '<input class="input-medium input-common" autocomplete="off" type="text" id="start_time" style="width:250px;" onclick="WdatePicker({skin:"twoer",dateFmt:"yyyy-MM-dd HH:mm:ss"})" />'+
                // '<span class="mlr5">至</span>'+
                // '<input class="input-medium input-common" autocomplete="off" size="15" type="text" id="end_time" style="width:250px;" onclick="WdatePicker({skin:"twoer",dateFmt:"yyyy-MM-dd HH:mm:ss"})">'+
                // '<p class="error">请输入生效时间</p>'+
                // '</dd>'+
                // '</dl>'+

                '<dl>'+
                '<dt>'+'预约名额'+'</dt>'+
                '<dd>'+'<input  type="number" name="user_num" data-id='+i+' min="0" class="input-common user_num"  style="width: 50px" value="'+data[i].user_num+'"/> <span>人</span>'+'</dd>'+
                '</dd>'+
                '</dl>'+

                '<dl style="border-bottom: none;">'+
                '<dt>'+'电子券面'+'</dt>'+
                '<dd>'+
                '<div class="class-logo">'+
                '<p>'+
                {if condition="$data[i].coupon_pic eq ''"}
				'<img id="imglogo1">'+
				{else/}
                '<img id="imglogo1" src="'+data[i].coupon_pic+'">'+
				{/if}
                '</p>'+
                '</div>'+
                '<div class="upload-btn">'+
                '<span>'+
                '<input class="input-file" name="file_upload" id="test3'+i+'" data-id='+i+' type="file" onchange="imgUpload4(this)">'+
                '<input type="hidden" id="'+i+'"/>'+
                '</span>'+
                '<p>'+'<i class="fa fa-cloud-upload">'+'</i>'+'上传图片'+'</p>'+
                '</div>'+
                '<p class="hint">'+
                '<br>'+'<span style="color: orange;">'+'建议使用宽1200像素-高300像素内的GIF或PNG透明图片;'+'</span>'+
                '</p>'+
                '</dd>'+
                '</dl>'+

                '</div>'
			);
		}
	}

	$(function(){
		for (var i = 0; i < data.length;  i ++) {
			$("#i" + i).attr("src", __IMG(data[i].pic));
			if (data[i].pic_link == '' || data[i].pic_link == '无链接'){
				$("#1_a" + i).attr("selected",'selected');
			}else if(data[i].pic_link == '主页'){
				$("#2_a" + i).attr("selected",'selected');
			}else if (data[i].pic_link == '全部商品') {
				$("#3_a" + i).attr("selected", 'selected');
			}else if (data[i].pic_link == '礼品专区') {
				$("#4_a" + i).attr("selected", 'selected');
			}else if (data[i].pic_link == '会员专区'){
				$("#5_a" + i).attr("selected",'selected');
			}else if (data[i].pic_link == '商品详情页'){
				$("#6_a" + i).attr("selected",'selected');
				$("#9_a" + i).parent().show();
				$("#9_a" + i).attr("value", data[i].pic_link);
			}else{
				$("#7_a" + i).attr("selected",'selected');
				$("#8_a" + i).parent().show();
				$("#8_a" + i).attr("value", data[i].pic_link);
			}
			//		title_link
			if (data[i].title_link == '' || data[i].title_link == '无链接'){
				$("#1_b" + i).attr("selected",'selected');
			}else if(data[i].title_link == '主页'){
				$("#2_b" + i).attr("selected",'selected');
			}else if (data[i].title_link == '全部商品') {
				$("#3_b" + i).attr("selected", 'selected');
			}else if (data[i].pic_link == '礼品专区') {
				$("#4_b" + i).attr("selected", 'selected');
			}else if (data[i].pic_link == '会员专区'){
				$("#5_b" + i).attr("selected",'selected');
			}else if (data[i].pic_link == '商品详情页'){
				$("#6_b" + i).attr("selected",'selected');
				$("#9_a" + i).parent().show();
				$("#9_a" + i).attr("value", data[i].pic_link);
			}else {
				$("#7_b" + i).attr("selected",'selected');
				$("#8_b" + i).parent().show();
				$("#8_b" + i).attr("value", data[i].title_link);
			}
			//		content_link
			if (data[i].content_link == '' || data[i].content_link == '无链接'){
				$("#1_c" + i).attr("selected",'selected');
			}else if(data[i].content_link == '主页'){
				$("#2_c" + i).attr("selected",'selected');
			}else if (data[i].content_link == '全部商品') {
				$("#3_c" + i).attr("selected", 'selected');
			}else if (data[i].pic_link == '礼品专区') {
				$("#4_c" + i).attr("selected", 'selected');
			}else if (data[i].pic_link == '会员专区'){
				$("#5_c" + i).attr("selected",'selected');
			}else if (data[i].pic_link == '商品详情页'){
				$("#6_c" + i).attr("selected",'selected');
				$("#9_a" + i).parent().show();
				$("#9_a" + i).attr("value", data[i].pic_link);
			}else {
				$("#7_c" + i).attr("selected",'selected');
				$("#8_c" + i).parent().show();
				$("#8_c" + i).attr("value", data[i].content_link);
			}
			if (data[i].content_type == 1){
				$("#a" + i).attr("checked",'checked');
			}else if(data[i].content_type == 2){
				$("#b" + i).attr("checked",'checked');
			}else{
				$("#c" + i).attr("checked",'checked');
			}
			if (data[i].title_type == 1){
				$("#d" + i).attr("checked",'checked');
			}else if(data[i].title_type == 2){
				$("#e" + i).attr("checked",'checked');
			}else{
				$("#f" + i).attr("checked",'checked');
			}
		}
	});


	$(document).on('click','.delete_data',function(){
		var index = $(this).attr('id');
		data.splice(index , 1);
		$($(this)).parent().parent().remove();
	});


	$(document).on('click','.delete_new_data',function(){
		var data = allData.items;
		var index = $(this).attr('id');
		data.splice(index, 1);
		$($(this)).parent().parent().remove();
	});

	$(document).on('blur','.sort',function(){
		var sort = $(this).val();
		var index = $(this).data('id');
		data[index].sort = sort;
	});

	$(document).on('blur','.title_master',function(){
		var title_master = $(this).val();
		var index = $(this).data('id');
		data[index].title = title_master;
	});
	$(document).on('blur','.title_slaver',function(){
		var title_slaver = $(this).val();
		var index = $(this).data('id');
		data[index].title_slaver = title_slaver;
	});
	$(document).on('blur','.title_type',function(){
		var title_type = $(this).val();
		var index = $(this).data('id');
		data[index].title_type = title_type;
	});
	$(document).on('blur','.title_link',function(){
		var title_link = $(this).val();
		var index = $(this).data('id');
		data[index].title_link = title_link;
	});

	$(document).on('blur','.input-file',function(){
		var pic = $(this).val();
		formatData($(this).data('id'),pic,'pic');
	});

	$(document).on('blur','.pic_link',function(){
		var pic_link = $(this).val();
		var index = $(this).data('id');
		data[index].pic_link = pic_link;
	});

	$(document).on('blur','.content',function(){
		var content = $(this).val();
		var index = $(this).data('id');
		data[index].content = content;
	});

	$(document).on('blur','.content_type',function(){
		var content_type = $(this).val();
		var index = $(this).data('id');
		data[index].content_type = content_type;
	});

	$(document).on('blur','.content_link',function(){
		var content_link = $(this).val();
		var index = $(this).data('id');
		data[index].content_link = content_link;
	});

	$(document).on('blur','.content_pro',function(){
		var content_pro = $(this).val();
		var index = $(this).data('id');
		data[index].content_pro = content_pro;
	});

	$(document).on('blur','.title_pro',function(){
		var title_pro = $(this).val();
		var index = $(this).data('id');
		data[index].title_pro = title_pro;
	});


	$(document).on('blur','.movie_show',function(){
		var movie_show = $(this).val();
		var index = $(this).data('id');
		data[index].movie_show = movie_show;
	});


	function formatData (index,val,type){
		allData.items.forEach(v=>{
			if(v.id == index) {
			v[type] = val;
		}
		return v;
	});
	}

	$(document).on('change','.select-common',function(){
		if ($(this).val() == 'options_value'){
			$($(this)).parent().next().children().show();
		}else{
			$($(this)).parent().next().children().hide();
		}
		if ($(this).val() == '商品详情页'){
			$($(this)).parent().next().children().next().show();
		}else{
			$($(this)).parent().next().children().next().hide();
		}
	});


	function validation(){
		var title=$("#title");								//专题标题
		if(title.val() == ""){
			title.next().css("display","inline-block");
			title.focus();
			return false;
		}
		return true;
	}

	var flag = false;//防止重复提交
	function save(type){
        if(type==1){
			var status=0;
		}else{
			var status=1;
		}
        allData['status'] = status;
        allData['pic'] = $("#logo").val();
        allData['icon_link'] = $("#logo_icon").val();
        allData['title'] = $("#title").val();
        allData['master_sort'] = $("#master_sort").val();
        allData['is_show'] = $('#blank_type input[name="is_show"]:checked ').val();

		if(!validation()){
			return;
		}
		if(flag){
			return;
		}
		flag = true;
		$.ajax({
			type:"post",
			url:"{:__URL('ADMIN_MAIN/cms/updatetopic')}",
			data:allData,
			success:function(data){
				if (data["code"] > 0) {
					showMessage('success', data["message"]);
					location.href=__URL("ADMIN_MAIN/cms/topiclist");
				}else{
					showMessage('error', data["message"]);
					flag = false;
				}
			}
		});
	}


	/**
	 *图片上传
	 */
	function imgUpload(event) {
		var fileid = $(event).attr("id");
		var data = { 'file_path' : UPLOADCOMMON };
		uploadFile(fileid,data,function(res){
			if(res.code){
				$("#imglogo").attr("src",__IMG(res.data));
				$("#logo").val(res.data);
				showTip(res.message,"success");
			}else{
				showTip(res.message,"error");
			}
		});
	}


	/**
	 *图片上传
	 */
	function imgUpload_icon(event) {
		var fileid = $(event).attr("id");
		var data = { 'file_path' : UPLOADCOMMON };
		uploadFile(fileid,data,function(res){
			if(res.code){
				$("#imglogo_icon").attr("src",__IMG(res.data));
				$("#logo_icon").val(res.data);
				showTip(res.message,"success");
			}else{
				showTip(res.message,"error");
			}
		});
	}

	//图片上传
	function imgUpload1(event) {
		var fileid = $(event).attr("id");
		var id = $(event).data('id');
		var imgDom = $(event).parent().parent().prev().children().children();
		var data_img = { 'file_path' : UPLOADCOMMON }
		uploadFile(fileid,data_img,function(res){
			if(res.code){
				imgDom.attr("src",__IMG(res.data));
				$(event).next().val(res.data);
				data[id].pic = res.data;
				showTip(res.message,"success");
			}else{
				showTip(res.message,"error");
			}
		});
	}


	//图片上传
	function imgUpload2(event) {
		var fileid = $(event).attr("id");
		var id = $(event).data('id');
		var imgDom = $(event).parent().parent().prev().children().children();
		var data_img = { 'file_path' : UPLOADCOMMON }
		new_uploadFile(fileid,data_img,function(res){
			if(res.code){
				imgDom.attr("src",__IMG(res.data));
				$(event).parent().next().val(res.data);
				data[id].pic_pro = res.data;
				showTip(res.message,"success");
			}else{
				showTip(res.message,"error");
			}
		});
	}

    //添加图片
    $(document).on('click','#show_div0',function(){
        var newId = allData.items.length;
        allData.items.push({
            id:newId,
            index_pic:'index_pic',
            pic_link:''
        });
        $("#selecter").append(
            '<div id="div0">'+
            '<dl style="height: 50px;background-color: #F5F6F5;margin-top: 60px;">'+
            '<dt style="font-size: 15px;color: black;font-weight: bold">'+'添加图片'+'</dt>'+
            '<dt class="delete_data" id="'+newId+'"><span>'+'删除'+'</span></dt>'+
            '</dl>'+
            '<dl style="border-bottom: none;">'+
            '<dt>'+'详情图片'+'</dt>'+
            '<dd>'+
            '<div class="class-logo">'+
            '<p>'+
            '<img class="imglogo1">'+
            '</p>'+
            '</div>'+
            '<div class="upload-btn">'+
            '<span>'+
            '<input class="input-file" name="file_upload" id="test'+newId+'" data-id='+newId+' type="file" onchange="imgUpload1(this)">'+
            '<input type="hidden" id="'+newId+'"/>'+
            '</span>'+
            '<p>'+'<i class="fa fa-cloud-upload">'+'</i>'+'上传图片'+'</p>'+
            '</div>'+
            '<p class="hint">'+
            '<br>'+'<span style="color: orange;">'+'建议使用宽1200像素-高300像素内的GIF或PNG透明图片;'+'</span>'+
            '</p>'+
            '</dd>'+
            '</dl>'+

            '<dl style="border-bottom: none;">'+
            '<dt>'+'链接'+'</dt>'+
            '<dd>'+
            '<div style="float: left">'+
            '<select  class="select-common pic_link" data-id='+newId+' name="pic_link">'+
            '<option value="无链接">'+'无链接'+'</option>'+
            '<option value="主页">'+'主页'+'</option>'+
            '<option value="全部商品">'+'全部商品'+'</option>'+
            '<option value="礼品专区">'+'礼品专区'+'</option>'+
            '<option value="会员专区">'+'会员专区'+'</option>'+
            '<option value="商品详情页">'+'商品详情页'+'</option>'+
            '<option value="options_value">'+'小程序路径'+'</option>'+
            '</select>'+
            '</div>'+
            '<div style="float: left;margin-left: 20px">'+
            '<div class="option4" style="display:none">'+
            '<input type="text" class="pic_link" name="pic_link" data-id='+newId+' placeholder="请输入小程序路径,如/pages/index/index" >'+
            '</div>'+
            '<div class="option4" style="display:none">'+
            '<input type="number" class="pic_link" name="pic_link" data-id='+newId+' placeholder="请输入详情页id,如12" >'+
            '</div>'+
            '</div>'+
            // '<dt>'+'排序'+'</dt>'+
            // '<dd>'+'<input  type="number" name="sort" data-id='+newId+' min="0" class="input-common sort" />'+'</dd>'+
            '</dd>'+
            '</dl>'+
            '</div>'
        )
    });
    //		end



    $(document).on('click','#show_div1',function(){
        var newId = allData.items.length;
        allData.items.push({
            id : newId,
            index_video : '',
            video_pic : ''
        });
        $("#selecter").append(
            '<div id="div1">'+
            '<dl style="height: 50px;background-color: #F5F6F5;border-bottom: none">'+
            '<dt style="font-size: 15px;color: black;font-weight: bold">'+'添加视频'+'</dt>'+
            '<dt class="delete_data" id="'+newId+'"><span>'+'删除'+'</span></dt>'+
            '</dl>'+

            '<dl style="border-bottom: none;">'+
            '<dl>'+
            '<dd style="margin-left: 10%">'+
            '<div class="controls" style="background-color:#FFF;border: 1px solid #E9E9E9;">'+
            '<div class="ncsc-goods-default-pic">'+
            '<div class="goodspic-uplaod" style="padding: 15px;">'+
            '<div style="min-height:120px;">'+
            '<div class="video-thumb" >'+
            '<video id="my-video'+newId+'" controls poster="__STATIC__/blue/img/vs.png" preload="auto"  style="max-width:50%;max-height:100%;width:auto;height:auto;">'+
            '<source src="" type="video/mp4" id="video-source">'+
            '</video>'+
            '<span class="del-video hide" data-id='+newId+' onclick="del_video(this)"></span>'+
            '</div>'+
            '</div>'+
            '<div class="clear"></div>'+
            '<div class="handle">'+
            '<div class="ncsc-upload-btn">'+
            '<a href="javascript:void(0);">'+
            '<span>'+
            '<input class="input-file video-file" name="file_upload" id="test'+newId+'" data-id='+newId+' type="file" onchange="fileUpload_video(this);"  value="">'+
            '</span>'+
            '<p>视频上传</p>'+
            '<input type="hidden" class="video-file" id="video_url'+newId+'" value="">'+
            '</a>'+
            '</div>'+
            '</div>'+
            '</div>'+
            '</div>'+
            '</div>'+
            '</dd>'+
            '</dl>'+
            '</dl>'+

            '<dl style="border-bottom: none;">'+
            '<dt>'+'视频封面'+'</dt>'+
            '<dd>'+
            '<div class="class-logo">'+
            '<p>'+
            '<img class="imglogo1">'+
            '</p>'+
            '</div>'+
            '<div class="upload-btn">'+
            '<span>'+
            '<input class="input-file" name="file_upload" id="test1'+newId+'" data-id='+newId+' type="file" onchange="imgUpload2(this)">'+
            '<input type="hidden" id="'+newId+'"/>'+
            '</span>'+
            '<p>'+'<i class="fa fa-cloud-upload">'+'</i>'+'上传图片'+'</p>'+
            '</div>'+
            '<p class="hint">'+
            '<br>'+'<span style="color: orange;">'+'建议使用宽1200像素-高300像素内的GIF或PNG透明图片;'+'</span>'+
            '</p>'+
            '</dd>'+
            '</dl>'+

            // '<dl style="border-bottom: none;">'+
            // '<dt>'+'<span style="color:red;margin-left:15px;">'+'</span>'+'是否显示'+'</dt>'+
            // '<dd>'+
            // '<div id="position_type">'+
            // '<label for="navigationtype1" class="line-label"><input type="radio" value="1" data-id='+newId+' class="movie_show" name="movie_show'+newId+'" id="navigationtype1" checked="checked"/>'+' 显示'+'</label>'+
            // '<label for="navigationtype2" class="line-label"><input type="radio" value="0" data-id='+newId+' class="movie_show" name="movie_show'+newId+'" id="navigationtype2"/>'+' 隐藏'+'</label>'+
            // '</div>'+
            // '</dd>'+
            // '</dl>'+
            // '<dl>'+
            // '<dt>'+'排序'+'</dt>'+
            // '<dd>'+'<input  type="number" name="sort" data-id='+newId+' min="0" class="input-common sort" />'+'</dd>'+
            // '<dd>'+

            '</dl>'+
            '</div>'
        )
    });


    $(document).on('click','#show_div2',function(){
        var newId = allData.items.length;
        allData.items.push({
            id:newId,
            appointment_pic:'',
            start_time:'',
            end_time:'',
            user_num:'',
            coupon_pic:''
        });
        $("#selecter").append(
            '<div id="div2">'+
            '<dl style="height: 50px;background-color: #F5F6F5;margin-top: 60px;">'+
            '<dt style="font-size: 15px;color: black;font-weight: bold">'+'预约服务'+'</dt>'+
            '<dt class="delete_data" id="'+newId+'"><span>'+'删除'+'</span></dt>'+
            '</dl>'+
            '<dl style="border-bottom: none;">'+
            '<dt>'+'预约图片'+'</dt>'+
            '<dd>'+
            '<div class="class-logo">'+
            '<p>'+
            '<img class="imglogo1">'+
            '</p>'+
            '</div>'+
            '<div class="upload-btn">'+
            '<span>'+
            '<input class="input-file" name="file_upload" id="test2'+newId+'" data-id='+newId+' type="file" onchange="imgUpload3(this)">'+
            '<input type="hidden" id="'+newId+'"/>'+
            '</span>'+
            '<p>'+'<i class="fa fa-cloud-upload">'+'</i>'+'上传图片'+'</p>'+
            '</div>'+
            '<p class="hint">'+
            '<br>'+'<span style="color: orange;">'+'建议使用宽1200像素-高300像素内的GIF或PNG透明图片;'+'</span>'+
            '</p>'+
            '</dd>'+
            '</dl>'+

            // '<dl>'+
            // '<dt><span style="color:red;">*</span>&nbsp;&nbsp;活动时间:</dt>'+
            // '<dd>'+
            // '<input class="input-medium input-common" autocomplete="off" type="text" id="start_time" style="width:250px;" onclick="WdatePicker({skin:"twoer",dateFmt:"yyyy-MM-dd HH:mm:ss"})" />'+
            // '<span class="mlr5">至</span>'+
            // '<input class="input-medium input-common" autocomplete="off" size="15" type="text" id="end_time" style="width:250px;" onclick="WdatePicker({skin:"twoer",dateFmt:"yyyy-MM-dd HH:mm:ss"})">'+
            // '<p class="error">请输入生效时间</p>'+
            // '</dd>'+
            // '</dl>'+

            '<dl>'+
            '<dt>'+'预约名额'+'</dt>'+
            '<dd>'+'<input  type="number" name="user_num" data-id='+newId+' min="0" class="input-common user_num"  style="width: 50px"/> <span>人</span>'+'</dd>'+
            '</dd>'+
            '</dl>'+

            '<dl style="border-bottom: none;">'+
            '<dt>'+'电子券面'+'</dt>'+
            '<dd>'+
            '<div class="class-logo">'+
            '<p>'+
            '<img class="imglogo1">'+
            '</p>'+
            '</div>'+
            '<div class="upload-btn">'+
            '<span>'+
            '<input class="input-file" name="file_upload" id="test3'+newId+'" data-id='+newId+' type="file" onchange="imgUpload4(this)">'+
            '<input type="hidden" id="'+newId+'"/>'+
            '</span>'+
            '<p>'+'<i class="fa fa-cloud-upload">'+'</i>'+'上传图片'+'</p>'+
            '</div>'+
            '<p class="hint">'+
            '<br>'+'<span style="color: orange;">'+'建议使用宽1200像素-高300像素内的GIF或PNG透明图片;'+'</span>'+
            '</p>'+
            '</dd>'+
            '</dl>'+

            '</div>'
        );
    });



	//点击遮罩隐藏商品选择框
	$(document).on('click','.combo-package-mask-layer',function(){
		modal("hide");
	});

	//全选
	function CheckAll(obj){
		var checked = obj.checked;
		$(".table-class tbody tr input:checkbox").prop("checked",checked);
	}




	//点击确定
	$(document).on('click','#determine',function(){
		$('#goods_id_array').val($("input[name='sub']:checked").val());
		var id = $("input[name='sub']:checked").val();
		var index = record;
		formatData(allData['items'][index].id,id,'pid');
		if(id > 0){
			$.ajax({
				type : "post",
				url : "{:__URL('ADMIN_MAIN/goods/getGoodsFieldInfo')}",
				data : {
					"id" : id,
				},
				async : false,
				success : function(data) {
					formatData(allData['items'][index].id,data['goods_name'],'goods_name');
					formatData(allData['items'][index].id,data['material_code'],'material_code');
					formatData(allData['items'][index].id,data['price'],'price');
					formatData(allData['items'][index].id,data['stock'],'stock');
				}
			})
		}
		refreshSelectGoods(index);
		modal("hide");
	})
	//模态框隐藏显示
	function modal(type){
		if(type == "show"){
			$(".combo-package-mask-layer").show();
			$(".goods-list-mask-layer").show();
		}else if(type == "hide"){
			$(".combo-package-mask-layer").hide();
			$(".goods-list-mask-layer").hide();
		}
	}

	//商品取消选择
	function cancelSelect(goods_id){
		for(var i = 0; i < BatchSend.length; i++){
			if(BatchSend[i] == goods_id){
				BatchSend.splice(i,1);
			}
		}
		$("#goods_id_array").val(BatchSend.toString());
		refreshSelectGoods();
	}



	//价格
	$("#combo_package_price").change(function(){
		var price = parseFloat(parseFloat($(this).val()).toFixed(2));
		var original_price = parseFloat(parseFloat($("#original_price").text()).toFixed(2)); //原价
		if(price < 0){
			price = 0;
		}else if(price > original_price){
			price = original_price;
		}
		$(this).val(price);
		calculate_original_price();
	})

	//重置
	function click_reset(){
		BatchSend = Array();
		$("#goods_id_array").val("");
		$(".goods-list .table-class tbody").html("");
	}

	function calculate_original_price(){
		var original_price = 0;
		$(".goods-list .table-class tbody tr td.goods_price").each(function(i,e){
			var price = parseFloat($(e).text());
			original_price += price;
		})
		var combo_package_price = parseFloat($("#combo_package_price").val());
		$("#original_price").text(original_price.toFixed(2)); //原价
		if(combo_package_price > 0){
			if(combo_package_price > original_price){
				combo_package_price = original_price;
				$("#combo_package_price").val(combo_package_price);
			}
			$("#save_the_price").text((original_price - combo_package_price).toFixed(2)); //节省价
		}
	}


	//查看商品
	$(document).on('click','#ceshi',function(){
		var index = $(this).data('id');
		var dom = $(this);
		var id = allData['items'][index]['pid'];
		$.ajax({
			type : "post",
			url : "{:__URL('ADMIN_MAIN/goods/getGoodsFieldInfo')}",
			data : {
				"id" : id,
			},
			async : false,
			success : function(data) {
				var html = '';

				html += '<tr>';
				html += '<input value="' + id + '"  type="hidden">';

				html += '<td>' + data.goods_name + '</td>';

				html += '<td>' + data.material_code + '</td>';


				html += '<td class="goods_price">' + data.price + '</td>';

				html += '<td>' + data.stock  + '</td>';

				html += '<td><label for=""><i class="fa fa-times" aria-hidden="true fa-2x" onclick="cancelSelect('+index+')"></i></label></td>';

				html += '</tr>';

				$(dom).parent().parent().next().children().children().children('tbody:last-child').html(html);
			}
		})
		calculate_original_price(); //计算原价
	})


    /**
     * 文件上传（视频、音频）
     */
    function fileUpload_video(event) {
        var fileid = $(event).attr("id");
        var id = $(event).data('id');
        var data_id = $(event).attr("data-id");
        var data_video = { 'file_path' : UPLOADGOODSVIDEO };
        var dom = document.getElementById(fileid);
        var file = dom.files[0];//File对象;
        var fileTypeArr = ['video/mp4', 'video/3gp', 'video/avi', 'video/rmvb', 'video/rm'];
        var flag = false;
        if (file != null) {
            for (var i = 0; i < fileTypeArr.length; i++) {
                if (file.type == fileTypeArr[i]) {
                    flag = true;
                    break;
                }
            }
        }
        if (!flag) {
            showTip("文件类型不合法", "warning");
        } else {
            uploadFile(fileid, data_video, function (res) {
                if (res.code) {
                    $("#video_url"+data_id).val(res['data']);
                    $("#my-video"+data_id).attr('poster','');
                    $("#my-video"+data_id).attr('src',__IMG(res['data']));
                    data[id].movie_link = res.data;
                    $(".del-video").show();
                    showTip(res.message, "success");
                } else {
                    showTip(res.message, "error");
                }
            });
        }
    }


    /**
     * 删除已选择的视频
     */
    function del_video(event) {
        // 通过ajax用php删除文件
        var data_id = $(event).attr("data-id");
        var src 	= $("#video_url"+data_id).val();
        if (src != "") {
            $("#my-video"+data_id).attr('src', "");
            $("#my-video"+data_id).attr('poster', '__STATIC__/blue/img/vs.png');
            $("#videoupload").val('');
            $(".del-video").hide();
            $("#video_url"+data_id).val('');
        }
    }


</script>
{/block}



