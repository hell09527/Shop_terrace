{extend name="adminblue/base" /}
{block name="resources"/}
<script src="ADMIN_JS/My97DatePicker/WdatePicker.js" type="text/javascript"></script>
<style  type="text/css">
	.set-style h4{color:#0072D2;margin-left:10px;}
	#motai-div{min-width: 60%}
	#myModal{min-width: 60%}
	.modal{left: 42%}
</style>
{/block}
{block name="main"}
<div class="set-style">
	<h4>活动信息</h4>
	<dl>
		<dt><span style="color:red;">*</span>&nbsp;&nbsp;活动名称:</dt>
		<dd>
			<input type="text" id="mansong_name" maxlength="10" value="{$mansong_info['mansong_name']}" class="input-common">
			<p class="error">请输入活动名称</p>
		</dd>
	</dl>
	<dl>
		<dt><span style="color:red;">*</span>&nbsp;&nbsp;生效时间:</dt>
		<dd>
			<input class="input-medium input-common" type="text" id="start_time" value="{$mansong_info['start_time'] | getTimeStampTurnTime}" style="width:250px;"onclick="WdatePicker({skin:'twoer',dateFmt:'yyyy-MM-dd HH:mm:ss'})">
			<span class="mlr5">至</span>
			<input class="input-medium input-common" size="15" type="text" id="end_time" value="{$mansong_info['end_time'] | getTimeStampTurnTime}" style="width:250px;"onclick="WdatePicker({skin:'twoer',dateFmt:'yyyy-MM-dd HH:mm:ss'})">
			<p class="error">请输入生效时间</p>
		</dd>
	</dl>
	<h4>优惠设置</h4>
	<dl>
		<dt>优惠方式:</dt>
		<dd>
			<label><input class="input-mini" type="radio" name="type" value="1" {if condition="$mansong_info['type'] eq 1"}checked="checked"{/if} {if condition="$mansong_info['type'] eq 2"}disabled{/if}> 普通优惠</label>
			<label><input class="input-mini" type="radio" name="type" value="2" {if condition="$mansong_info['type'] eq 2"}checked="checked"{/if}> 多级优惠</label>
			<p class="hint">（每级优惠不累积叠加）</p>
		</dd>
	</dl>
	<dl>
		<dt><span style="color:red;">*</span>&nbsp;&nbsp;优惠条件:</dt>
		<dd style="width:100%;">
			<div class="table-responsive">
				<table class="table table-cj">
					<thead>
					<tr>
						<th>层级</th>
						<th>优惠门槛</th>
						<th>优惠方式（可多选）</th>
						<th>操作</th>
					</tr>
					</thead>
					<tbody>
					{volist name="mansong_info['rule']" id="vo" key="k"}
					<tr>
						<td>{$key+1}</td>
						<td>满&nbsp;<input type="text" id="price{$key+1}" value="{$vo['price']}" style="width:50px;height: 20px;vertical-align:middle;" class="input-common">&nbsp;元</td>
						<td>
							<div>
								<p>
									<label style="width: 200px">
										<input type="checkbox" name="mansong" class="discount{$key+1}" onchange="set_rule('discount',{$key+1},this)" {if condition="$vo['discount'] gt 0"}checked{/if}>
										<span id="discount{$key+1}">{if condition="$vo['discount'] gt 0"}减<input type='text' id='discount_input{$key+1}' value="{$vo['discount']}" style='width:50px;height: 16px;'/>元{else/}减现金{/if}</span>
									</label>
								</p>
								<p>
									<label style="width: 100px">
										<input type="checkbox" name="mansong" class="free_shipping{$key+1}" {if condition="$vo['free_shipping'] eq 1"}checked{/if}>
										<span id="free_shipping{$key+1}">免邮</span>
									</label>
								</p>
								<p>
									<label style="width: 100px">
										<input type="checkbox" name="mansong" class="give_coupon{$key+1}" onchange="set_rule('give_coupon',{$key+1},this)" {if condition="$vo['give_coupon'] gt 0"}checked{/if}>
										<span id="give_coupon{$key+1}">{if condition="$vo['give_coupon'] gt 0"}送<select id="give_coupon_select{$key+1}">{volist name="coupon_type_list['data']" id="vc"}<option value="{$vc['coupon_type_id']}" {if condition="$vo['give_coupon'] eq $vc['coupon_type_id']"}selected{/if}>{$vc['coupon_name']}</option>{/volist}</select>{else/}送优惠券{/if}</span>
									</label>
								</p>
								<p>
									<label style="width: 100px">
										<input type="checkbox" name="mansong" disabled class="gift_id{$key+1}"  {if condition="$vo['gift_id'] gt 0"}checked{/if}>
										送赠品
									</label>
								<div id="gift_id{$key+1}">
									{if condition="$vo['gift_id'] gt 0"}
									<div style="border: 1px solid grey">
										{volist name="vo['gift_arr']" id="vvv"}
										<br>
										{if condition="$vvv['is_check'] eq 1"}
										<label class="checkbox-inline" style="display:inline;margin-left: 10px">
											<input type="checkbox" id="gift_id_select{$k}" checked class="gift_id_select{$k}" value="{$vvv.gift_id}">&nbsp;{$vvv.gift_name}
										</label>
										<input type="number" value="{$vvv['n_num']}" style="width:50px;height: 14px;margin-top: 10px;vertical-align:middle"/>
										<span style="color: darkgrey"> &nbsp;剩余: </span>
										<span style="color: darkgrey">{$vvv['gift_num'] - $vvv['gift_song_num']}</span>
										{else}
										<label class="checkbox-inline" style="display:inline;margin-left: 10px">
											<input type="checkbox" id="gift_id_select{$k}"  class="gift_id_select'+num+'" value="{$vvv.gift_id}">&nbsp;{$vvv.gift_name}
										</label>
										<input type="number" style="width:50px;height: 14px;margin-top: 10px;vertical-align:middle"/>
										<span style="color: darkgrey"> &nbsp;剩余: </span>
										<span style="color: darkgrey">{$vvv['gift_num'] - $vvv['gift_song_num']}</span>
										{/if}
										{/volist}
									</div>
									{/if}
								</div>
								</p>
							</div>
						</td>
						<td>{if condition="$key+1 > 1"}<a href="javascript:void(0);" onclick="del_cengji({$key+1})">删除</a>{/if}</td>
					</tr>
					{/volist}
					</tbody>
					<tfoot style="display:none;">
					<tr>
						<td colspan="4">
							<a href="javascript:void(0)" onclick="add_reward()">+新增一级优惠</a>
							<span class="gray pl20">最多可设置十个层级</span>
						</td>
					</tr>
					</tfoot>
				</table>
			</div>
		</dd>
	</dl>
	{include file="adminblue/Promotion/selectNeiGouGoods" /}

</div>
<input type="hidden" id="mansong_id" value="{$mansong_info['mansong_id']}"/>
<dl style="text-align: center">
	<button class="btn-common btn-big" id="save_button" onclick="saveGoods();">保存</button>
	<button class="btn-common btn-big" id="submit_button" onclick="updateMansong();" style="display: none">提交
	</button>
</dl>
<script>
	//保存
	var flag = false;//防止重复提交

	$(function(){
		$("[name='range_type']").parents("dl").hide();
		$('.type_dl dd').hide();
		$(".ui-nav-tab").find('li:first').addClass('active');
		select_goods($("ul.ui-nav-tab li.js-tab").eq(1));

		$goods_selected_array 	 = {$mansong_info}.goods_list;
		$goods_id_selected_array = {$mansong_info}.goods_id_array;
		$sku_id_selected_array   = {$mansong_info}.sku_id_array;
		LoadingInfo(1);
		$("#some_pro").show();
		refresh_data();
		if({$mansong_info}.type == 2){
			$(".table tfoot").show();
		}
	});

	function LoadingInfo(page_index) {
		var group_id 	     = $("#group_id").val();
		var search_text      = $("#search_text").val();
		var search_sku       = $("#search_sku").val();
		var search_goods_sku = $("#search_goods_sku").val();
		var category_id_1    = $("#category_id_1").val();
		var category_id_2    = $("#category_id_2").val();
		var category_id_3    = $("#category_id_3").val();
		$.ajax({
			type : "post",
			url:"{:__URL('ADMIN_MAIN/goods/getsearchgoodslist')}",
			data : {
				"search_text" 	    : search_text,
				"search_sku" 	    : search_sku,
				"search_goods_sku" 	: search_goods_sku,
				"group_id"		    : group_id,
				"page_index" 	    : page_index,
				"page_size" 	    : $("#showNumber").val(),
				"state" 		    : 1 ,										// todo 只显示已上架的商品
				"category_id_1"     : category_id_1,
				"category_id_2"	    : category_id_2,
				"category_id_3"	    : category_id_3
			},
			success : function(data) {
				var html = '';
				if (data['data'].length > 0) {
//					$("#DiscountList").show();
					$data_array = data['data'];
					for (var i = 0; i < data['data'].length; i++) {
						var curr = $data_array[i];
						var row = curr.sku_arr.length;

						html +='<tr class="widget-list-item" id="select_'+curr["goods_id"]+'">';
						//选择框
						html +='<td style="text-align: center"><input type="checkbox" name="goods-select" goods_id="'+curr["goods_id"]+'" sku_id="'+curr.sku_arr[0]["sku_id"]+'"></td>';
						html +='<td class="goods-image-td text-center" rowspan="'+row+'"><div class="goods-image js-goods-image" style="width: 40px">';
						if(curr["picture_info"] != null){
							html +='<img src="'+__IMG(curr["picture_info"]['pic_cover_micro'])+'"></div></td>';
						}else{
							html +='<img src="__ROOT__/"></div></td>';
						}
						html +='<td class="goods-meta" rowspan="'+row+'"><p class="goods-title">';
						html +='<a href="'+__URL('SHOP_MAIN/goods/goodsinfo?goodsid='+curr["goods_id"])+'" target="_blank" class="new-window" title="'+curr["goods_name"]+'">'+curr["goods_name"]+'</a></p>';
						html +='<p class="goods-price">'+ curr["price"] +'</p></td>';
						html +='<td rowspan="'+row+'"><p class="text-center">'+curr["category_id_name"]+'</p></td>';
						html +='<td rowspan="'+row+'"><p class="text-center">'+curr["goods_type"]+'</p></td>';
						for(var l = 0; l < curr.sku_arr.length; l++){
							if(l > 0){
								html +='<tr class="widget-list-item">';
								//选择框
								html +='<td style="text-align: center"><input type="checkbox" name="goods-select" goods_id="'+curr["goods_id"]+'" sku_id="'+curr.sku_arr[l]["sku_id"]+'"></td>';
							}
							html +='<td class="text-center">'+curr.sku_arr[l]["sku_name"]+'</td>';
							html +='<td class="text-center">'+curr.sku_arr[l]["material_code"]+'</td>';
							html +='<td class="text-center">'+curr.sku_arr[l]["stock"]+'</td>';
							html +='<td class="text-center">'+curr.sku_arr[l]["price"]+'</td>';
							if($.inArray(curr.sku_arr[l]['sku_id'], $sku_id_selected_array) >= 0){
								for(var m = 0; m < $goods_selected_array.length; m++){
									if(curr["goods_id"] == $goods_selected_array[m]['goods_id']){
										for (var n = 0; n < $goods_selected_array[m].select_sku_arr.length; n++) {
											if(curr.sku_arr[l]["sku_id"] ==
													$goods_selected_array[m].select_sku_arr[n]['sku_id']){
												var n_discount = $goods_selected_array[m].select_sku_arr[n]['n_discount'];
												var sku_num = $goods_selected_array[m].select_sku_arr[n]['sku_num'];
											}
										}
									}
								}
								html +='<td id="select_one_'+curr.sku_arr[l]['sku_id']+'" class="text-center"><button type="button" class="btn btn-default js-remove-reward"  onclick="cancel_join('+curr.sku_arr[l]['sku_id']+','+curr["goods_id"]+')">取消参加</button></td>';
							}else{
								html +='<td id="select_one_'+curr.sku_arr[l]['sku_id']+'"  class="text-center"><button type="button" class="btn btn-primary js-add-reward"  onclick="join('+curr.sku_arr[l]['sku_id']+','+curr["goods_id"]+')">参加活动</button></td>';
							}
							html +='</tr>';
						}
					}
				} else {
					html += '<tr align="center"><td colspan="7">暂无符合条件的数据</td></tr>';
				}
				$("tbody.goods-list").html(html);

				initPageData(data["page_count"],data['data'].length,data['total_count']);
				$("#pageNumber").html(pagenumShow(jumpNumber,$("#page_count").val(),{$pageshow}));
			}
		});
	}

	function setDiscount(){
		$(".select-two input[type=number][name=discount]").each(function(i,d){
			var discount = $(d).val();
			var goodsid  = $(d).attr("goodsid");
			$(".discount_"+goodsid).children('input').val(discount);
		})
	}

	//折扣
	function discount(event){
		var discount = parseFloat($(event).val()).toFixed(2);
		if(discount <0.01){
			$(event).val(0.01);
			discount = 0.01;
		}else if(discount >9.99){
			$(event).val(9.99);
			discount = 9.99;
		}
		var goodsid = $(event).attr("goodsid");
		$(".discount_"+goodsid).children("input").val(discount);
	}

	function verify(discount_name, start_time, end_time, goods_id_array){
		if(discount_name == ''){
			$("#discount_name").parent().find('.error').show();
			return false;
		}else{
			$(".error").hide();
		}
		if(start_time == '' || end_time == ''){
			$("#start_time").parent().find('.error').show();
			return false;
		}else{
			$(".error").hide();
		}
		var dataTime = nowDate();
		var now 	 = new Date(dataTime.replace("-", "/").replace("-", "/"));
		var end 	 = new Date(end_time.replace("-", "/").replace("-", "/"));
		var start 	 = new Date(start_time.replace("-", "/").replace("-", "/"));
		if(end < now){
			$("#end_time").next().next('.error').show();
			return false;
		}else{
			$(".error").hide();
		}
		if(end < start){
			$("#end_time").next().next().next('.error').show();
			return false;
		}else{
			$(".error").hide();
		}
		if(goods_id_array == ''){
			showTip("请至少选择一件商品","warning");
			return false;
		}
		return true;
	}

	function updateMansong(){
		var mansong_id 	   = $("#mansong_id").val();
		var mansong_name   = $("#mansong_name").val();
		var start_time	   = $("#start_time").val();
		var end_time 	   = $("#end_time").val();
		var type 		   = $("input[type='radio'][name='type']:checked").val();
		var range_type 	   = 0;
		var is_neigou 	   = 1;
		var rule		   = '';
		var obj1 		   = $(".table-cj tbody tr");
		var goods_sku_arr  = '';

		if(!verify(mansong_name, start_time, end_time)){
			return false;
		}

		for(var i=0;i<$goods_selected_array.length;i++){
			for(var k=0;k<$goods_selected_array[i].select_sku_arr.length;k++){
				goods_sku_arr += ','+ $goods_selected_array[i].goods_id +':'+ $goods_selected_array[i].select_sku_arr[k].sku_id +':'+ $goods_selected_array[i].select_sku_arr[k].n_discount+':'+ $goods_selected_array[i].select_sku_arr[k].sku_num;
			}
		}

		if(goods_sku_arr.length > 0){
			goods_sku_arr = goods_sku_arr.substring(1);
		}

		for(var i = 1; i <= obj1.length; i++){
			//满减送价格
			if($("#price"+i).val() > 0){
				var price = $("#price"+i).val();
			}else{
				var price = 0;
				showMessage('error', '请输入优惠门槛金额');
				return false;
			}
			//减现金
			if($("input.discount"+i+"[type='checkbox']").is(':checked') == true){
				var discount = $("#discount_input"+i+"").val();
			}else{
				var discount = 0;
			}
			//免邮
			if($("input.free_shipping"+i+"[type='checkbox']").is(':checked') == true){
				var free_shipping = 1;
			}else{
				var free_shipping = 0;
			}
			//送优惠券
			if($("input.give_coupon"+i+"[type='checkbox']").is(':checked') == true){
				var give_coupon = $("#give_coupon_select"+i).val();
			}else{
				var give_coupon = 0;
			}
			//送赠品
			if($("input.gift_id"+i+"[type='checkbox']").is(':checked') == true){
				var gift_id = "";
				$('.gift_id_select'+i+':checked').each(function(){
					if($(this).parent().next().attr("value") == false){
						showMessage('error', '请填写赠品数量');
						return false;
					}
					if(Number($(this).parent().next().attr("value")) > Number($(this).parent().next().next().next().html())){
						showMessage('error', '赠品数量不能超过剩余数量');
						return false;
					}
					gift_id += $(this).attr("value") + ':' + $(this).parent().next().attr("value") +"/";
				});
			}else{
				var gift_id = 0;
			}
			if(discount+free_shipping+give_coupon+gift_id == 0){
				showMessage('error', '请至少选择一种优惠方式');
				return false;
			}
			rule += ';'+price+','+discount+','+free_shipping+','+give_coupon+','+gift_id;
		}
		rule = rule.substring(1);

		if(goods_sku_arr == '' && range_type == 0){
			showMessage('error', '请选择参加活动的商品');
			return false;
		}
		if(flag){
			return;
		}
		flag = true;
		$.ajax({
			type : "post",
			url : "{:__URL('ADMIN_MAIN/promotion/updateNeiGou')}",
			data : {
				'mansong_id' 	 : mansong_id,
				'mansong_name' 	 : mansong_name,
				'start_time' 	 : start_time,
				'end_time' 		 : end_time,
				'type' 			 : type,
				'range_type'	 : range_type,
				'is_neigou' 	 : is_neigou,
				'rule' 			 : rule,
				'goods_sku_arr'  : goods_sku_arr
			},
			success : function(data) {
				if (data["code"] > 0) {
					showMessage('success', data["message"],"{:__URL('ADMIN_MAIN/promotion/mansonglist')}");
				}else{
					showMessage('error', data["message"]);
					flag = false;
				}
			}
		});
	}
	/**
	 *模块输入信息验证
	 */
	function verify(mansong_name, start_time, end_time){
		if(mansong_name == ''){
			$("#mansong_name").parent().find('.error').show();
			return false;
		}else{
			$(".error").hide();
		}
		if(start_time == '' || end_time == ''){
			$("#start_time").parent().find('.error').show();
			return false;
		}else{
			$(".error").hide();
		}
		return true;
	}

	//控制商品列表显示数据
	function ShopRadio(num){
		if(num == 0){
			$("#some_pro").show();
		}else if(num == 1){
			$("#some_pro").hide();
			$("#DiscountList").hide();
			$("#goodsCountList tr").remove();
			$("#condition").val("");
			$goodsArr = new Array();
		}
	}

	//添加一级优惠
	function add_reward(){
		var len = $(".table-cj tbody tr").length;
		if(len >= 10){
			$(".table-cj tfoot").hide();
		}else{
			var cengji =  Number(len)+1;
			var html = '';
			html += '<tr>';
			html += '<td>'+cengji+'</td>';
			html += '<td>满&nbsp;<input type="text" id="price'+cengji+'" class="input-common" style="width:50px;height: 20px;vertical-align:middle;">&nbsp;元</td>';
			html += '<td><div>';
			html += '<p><label><input type="checkbox" name="mansong" class="discount'+cengji+'" onchange="set_rule(\'discount\','+cengji+',this)"><span id="discount'+cengji+'">&nbsp;减现金</span></label></p>';
			html += '<p><label><input type="checkbox" name="mansong" class="free_shipping'+cengji+'"><span id="free_shipping'+cengji+'">&nbsp;免邮</span></label></p>';
			html += '<p><label><input type="checkbox" name="mansong" class="give_coupon'+cengji+'" onchange="set_rule(\'give_coupon\','+cengji+',this)"><span id="give_coupon'+cengji+'">&nbsp;送优惠券</span></label></p>';
			html += '<p><label><input type="checkbox" name="mansong" class="gift_id'+cengji+'" onchange="set_rule(\'gift_id\','+cengji+',this)"><span id="gift_id'+cengji+'">&nbsp;送赠品</span></label></p>';
			html += '</div></td>';
			html += '<td><a href="javascript:void(0);" onclick="del_cengji('+cengji+')">删除</a></td>';
			html += '</tr>';
			$(".table-cj tbody").append(html);
			if(cengji == 10){
				$(".table-cj tfoot").hide();
			}
		}
	}

	function del_cengji(cengji){
		$(".table-cj tbody tr:last").remove();
	}

	$("input[name='type']").change(function(){
		var c = $(this).val();
		if(c == 2){
			$(".table-cj tfoot").show();
		}else{
			$(".table-cj tbody tr:gt(0)").remove();
			$(".table-cj tfoot").hide();
		}
	});

	//优惠类型点击
	function set_rule(type,num,e){
		if(type == 'discount'){
			discount(num,e);
		}else if(type == 'give_coupon'){
			give_coupon(num,e);
		}else if(type == 'gift_id'){
			gift_id(num,e);
		}
	}

	//减现金
	function discount(num,e){
		if(e.checked == true){
			var html = "&nbsp;减&nbsp;<input type='text' id='discount_input"+num+"' style='width:50px;height: 16px;vertical-align:middle;' class='input-common'/>&nbsp;元";
		}else{
			var html = "&nbsp;减现金";
		}
		$("#discount"+num).html(html);
	}

	//送优惠券
	function give_coupon(num,e){
		if(e.checked == true){
			$.ajax({
				type : "post",
				url  : "{:__URL('ADMIN_MAIN/promotion/coupontypelist')}",
				success : function(data) {
					var html = '&nbsp;送&nbsp;<select id="give_coupon_select'+num+'">';
					for(var i=0;i<data['data'].length;i++){
						html += '<option value="'+data['data'][i]['coupon_type_id']+'">'+data['data'][i]['coupon_name']+'</option>';
					}
					html += "</select>";
					$("#give_coupon"+num).html(html);
				}
			});
		}else{
			var html = "&nbsp;送优惠券";
			$("#give_coupon"+num).html(html);
		}
	}

	//送赠品
	function gift_id(num,e){
		if(e.checked == true){
			$.ajax({
				type : "post",
				url : "{:__URL('ADMIN_MAIN/promotion/giftlist')}",
				success : function(data) {
					var html = ' ';
					html += '<div style="border: 1px solid grey">';
					for(var i=0;i<data['data'].length;i++){
						if(data['data'][i]['gift_num'] > data['data'][i]['gift_song_num']){
							html += '<label class="checkbox-inline" style="display:inline;margin-left: 10px"><input type="checkbox" id="gift_id_select' + num + '" class="gift_id_select' + num + '" value="' + data['data'][i]['gift_id'] + '">&nbsp;'
									+ data['data'][i]['gift_name'] + '</label>';
							html += '&nbsp;<input type="number" id="gift_num'+num+'" class="gift_num' + num + '" style="width:50px;height: 14px;margin-top: 10px;vertical-align:middle"/>';
							html += '<span style="color: darkgrey"> &nbsp;剩余: </span>';
							html += '<span style="color: darkgrey">'+ (data['data'][i]['gift_num'] - data['data'][i]['gift_song_num'])+'</span>';
							html += '<br>';
						}
					}
					html += '</div>';
					$("#gift_id"+num).html(html);
				}
			});
		}else{
			$("#gift_id"+num).html('送赠品 ');
		}
	}

	//查看规格
	function skuDetail(goods_id,type,index){
		var goods_id = goods_id;
		var type     = type; //1:参加 2:取消
		if(type == '1'){
			var sku_arr  = $data_array[index].sku_arr;
			var html 	 = '';
			html += '<div class="modal-dialog modal-lg" role="document">';
			html += '<div class="modal-content">';
			html += '<div class="modal-header">';
			html += '<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>';
			html += '<h4 class="modal-title" id="myModalLabel">选择规格</h4>';
			html += '</div>';
			html += '<div class="modal-body">';
			html += '<table class="table table-bordered table-class">';
			html += '<thead>';
			html += '<tr>';
			html += '<th><input type="checkbox" onclick="CheckAll(this)"></th>';
			html += '<th>规格名称</th>';
			html += '<th>shopal编码</th>';
			html += '<th>库存</th>';
			html += '<th>价格</th>';
			html += '<th style="text-align:center;">内购价格</th>';
			html += '<th style="text-align:center;">活动数量</th>';
			html += '</tr>';
			html += '</thead>';
			html += '<tbody>';
			if (sku_arr.length > 0) {
				for (var i = 0; i < sku_arr.length; i++) {
					html += '<tr>';
					html += '<td><input name="sub" type="checkbox" value="'+ sku_arr[i]["sku_id"]+'" ></th>';
					html += '<td>'+ sku_arr[i]['sku_name'] +'</td>';
					html += '<td>'+ sku_arr[i]['material_code'] +'</td>';
					html += '<td>'+ sku_arr[i]['stock'] +'</td>';
					html += '<td>'+ sku_arr[i]['price'] +'</td>';
					html += '<td class="discount_'+sku_arr[i]["sku_id"]+'" style="width:100px;"><input type="number" style="width:60px;text-align:center;margin-bottom:0;" name="n_discount" sku_id="'+sku_arr[i]["sku_id"]+'" value="'+sku_arr[i]["price"]+'"/><span style="margin-left:3px;margin-top-3px;">元</span></td>';
					html += '<td class="discount_'+sku_arr[i]["sku_id"]+'" style="width:100px;"><input type="number" style="width:60px;text-align:center;margin-bottom:0;" name="sku_num" sku_id="'+sku_arr[i]["sku_id"]+'" value="1"/><span style="margin-left:3px;margin-top-3px;">件</span></td>';
					html += '</tr>';
				}
				html += '</tbody>';
				html += '</table>';
				html += '</div>';
				html += '<div class="modal-footer">';
				html += '<button type="button" class="btn btn-primary" data-dismiss="modal" onclick="join('+goods_id+')">参加活动</button>';
				html += '<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>';
				html += '</div>';
				html += '</div>';
			}else{
				html += '<tr align="center"><td colspan="7" style="text-align: center">暂无可选规格</td></tr>';
			}
			$("#motai-div").html(html);
		}else{
			var select_sku_arr   = $goods_selected_array[index].select_sku_arr;
			var html 		     = '';
			if (select_sku_arr.length > 0) {
				html += '<div class="modal-dialog" role="document">';
				html += '<div class="modal-content">';
				html += '<div class="modal-header">';
				html += '<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>';
				html += '<h4 class="modal-title" id="myModalLabel">已选规格</h4>';
				html += '</div>';
				html += '<div class="modal-body">';
				html += '<table class="table table-bordered table-class-s">';
				html += '<thead>';
				html += '<tr>';
				html += '<th><input type="checkbox" onclick="CheckAllS(this)"></th>';
				html += '<th>规格名称</th>';
				html += '<th>shopal编码</th>';
				html += '<th>库存</th>';
				html += '<th>价格</th>';
				html += '<th style="text-align:center;">内购价格</th>';
				html += '<th style="text-align:center;">活动数量</th>';
				html += '<th style="text-align:center;">剩余数量</th>';
				html += '</tr>';
				html += '</thead>';
				html += '<tbody>';
				for (var i = 0; i < select_sku_arr.length; i++) {
					html += '<tr>';
					html += '<td><input name="sub" type="checkbox" value="'+ select_sku_arr[i]["sku_id"]+'" ></th>';
					html += '<td>'+ select_sku_arr[i]['sku_name'] +'</td>';
					html += '<td>'+ select_sku_arr[i]['material_code'] +'</td>';
					html += '<td>'+ select_sku_arr[i]['stock'] +'</td>';
					html += '<td>'+ select_sku_arr[i]['price'] +'</td>';
					html += '<td class="discount_'+select_sku_arr[i]["sku_id"]+'" style="width:100px;"><input type="number" style="width:60px;text-align:center;margin-bottom:0;" name="n_discount" sku_id="'+select_sku_arr[i]["sku_id"]+'" value="'+select_sku_arr[i]["n_discount"]+'" disabled="none"/><span style="margin-left:3px;margin-top-3px;">元</span></td>';
					html += '<td class="discount_'+select_sku_arr[i]["sku_id"]+'" style="width:100px;"><input type="number" style="width:60px;text-align:center;margin-bottom:0;" name="sku_num" sku_id="'+select_sku_arr[i]["sku_id"]+'" value="'+select_sku_arr[i]["sku_num"]+'" disabled="none"/><span style="margin-left:3px;margin-top-3px;">件</span></td>';
					if(select_sku_arr[i]['use_num']){
						html += '<td style="text-align:center">'+ (select_sku_arr[i]['sku_num'] * 1 - select_sku_arr[i]['use_num'] * 1) +'</td>';
					}else{
						html += '<td style="text-align:center">'+ select_sku_arr[i]['sku_num'] +'</td>';
					}
					html += '</tr>';
				}
				html += '</tbody>';
				html += '</table>';
				html += '</div>';
				html += '<div class="modal-footer">';
				html += '<button type="button" class="btn btn-primary" data-dismiss="modal" onclick="cancel_join('+goods_id+','+index+')">撤销</button>';
				html += '<button type="button" class="btn btn-default" data-dismiss="modal">退出</button>';
				html += '</div>';
				html += '</div>';
				html += '</div>';
			}
			$("#myModal").html(html);
		}
	}
</script>
{/block}