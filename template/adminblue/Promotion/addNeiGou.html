{extend name="adminblue/base" /}
{block name="resources"/}
<script src="ADMIN_JS/My97DatePicker/WdatePicker.js" type="text/javascript"></script>
<style>
	.set-style h4{color:#0072D2;margin-left:10px;font-size:12px;}
	#motai-div{min-width: 60%}
	#myModal{min-width: 60%}
	.modal{left: 42%}
	/*.js-song-goods{display: none;}*/
</style>
{/block}
{block name="main"}
<div class="set-style">
	<h4>活动信息</h4>
	<dl>
		<dt><span style="color:red;">*</span>&nbsp;&nbsp;活动名称:</dt>
		<dd>
			<input type="text" id="mansong_name" maxlength="30" class="input-common"/>
			<p class="error">请输入活动名称</p>
		</dd>
	</dl>
	<dl>
		<dt><span style="color:red;">*</span>&nbsp;&nbsp;活动时间:</dt>
		<dd>
			<input class="input-medium input-common" autocomplete="off" type="text" id="start_time" style="width:250px;" onclick="WdatePicker({skin:'twoer',dateFmt:'yyyy-MM-dd HH:mm:ss'})" />
			<span class="mlr5">至</span>
			<input class="input-medium input-common" autocomplete="off" size="15" type="text" id="end_time" style="width:250px;" onclick="WdatePicker({skin:'twoer',dateFmt:'yyyy-MM-dd HH:mm:ss'})">
			<p class="error">请输入生效时间</p>
		</dd>
	</dl>

	<h4>优惠设置</h4>
	<dl>
		<dt>优惠方式:</dt>
		<dd>
			<label><input class="input-mini" type="radio" name="type" value="1" checked="checked" /> 普通优惠</label>
			<label><input class="input-mini" type="radio" name="type" value="2" /> 多级优惠</label>
			<p class="hint">（每级优惠不累积叠加）</p>
		</dd>
	</dl>
	<dl>
		<dt><span style="color:red;">*</span>&nbsp;&nbsp;优惠条件:</dt>
		<dd style="width:100%;">
			<div class="table-responsive">
				<table class="table table-cj">
					<thead>
					<tr>
						<th>层级</th>
						<th>优惠门槛</th>
						<th>优惠方式（可多选）</th>
						<th>操作</th>
					</tr>
					</thead>
					<tbody>
					<tr>
						<td>1</td>
						<td>满&nbsp;<input type="text" id="price1" class="input-common" style="width:50px;height: 20px;vertical-align: middle;">&nbsp;元</td>
						<td>
							<div>
								<p>
									<label style="width: 100px">
										<input type="checkbox" name="mansong" class="discount1" onchange="set_rule('discount',1,this)" />
										<span id="discount1">减现金</span>
									</label>
								</p>
								<p>
									<label style="width: 100px">
										<input type="checkbox" name="mansong" class="free_shipping1" />
										<span id="free_shipping1">免邮</span>
									</label>
								</p>
								<p>
									<label style="width: 100px">
										<input type="checkbox" name="mansong" class="give_coupon1" onchange="set_rule('give_coupon',1,this)" />
										<span id="give_coupon1">送优惠券</span>
									</label>
								</p>
								<p class="js-song-goods">
									<label style="width: 100px">
										<input type="checkbox" name="mansong" class="gift_id1" onchange="set_rule('gift_id',1,this)"/>
										送赠品
									</label>
									<span id="gift_id1"></span>
								</p>
							</div>
						</td>
						<td></td>
					</tr>
					</tbody>
					<tfoot style="display:none;">
					<tr>
						<td colspan="4">
							<a href="javascript:void(0)" onclick="add_reward()">+新增一级优惠</a>
							<span class="gray pl20">最多可设置十个层级</span>
						</td>
					</tr>
					</tfoot>
				</table>
			</div>
		</dd>
	</dl>

	{include file="adminblue/Promotion/selectNeiGouGoods" /}

</div>
<dl style="text-align: center">
	<button class="btn-common btn-big" id="save_button" onclick="saveGoods();">保存</button>
	<button class="btn-common btn-big" id="submit_button" onclick="addMansong();" style="display: none">提交
	</button>
</dl>
<script>
	$(function(){
		$("[name='range_type']").parents("dl").hide();
//		$(".kucun").after('<th class="text-center cell-10">内购价格</th>');
		$('.type_dl dd').hide();
		LoadingInfo(1);
		$("#some_pro").show();
	});
	function selected_goods(e){
		$(e).parents("ul.ui-nav-tab").find(".js-tab").removeClass("active");
		$(e).parents("li").addClass("active");
		$(".select-two").show();
		$(".select-one").hide();
		setDiscount();
	}
	function setDiscount(){
		$("input[type=number][name=n_price]").each(function(i,d){
			var discount = $(d).val();
			var goodsid = $(d).attr("goodsid");
			$(".discount_"+goodsid).children('input').val(discount);
		})
	}



	var flag = false;//防止重复提交

	//添加一级优惠
	function add_reward(){
		var len = $(".table-cj tbody tr").length;
		if(len >= 10){
			$(".table-cj tfoot").hide();
		}else{
			var cengji =  Number(len)+1;
			var html   = '';
			html += '<tr>';
			html += '<td>'+cengji+'</td>';
			html += '<td>满&nbsp;<input type="text" id="price'+cengji+'" class="input-common" style="width:50px;height: 20px;vertical-align:middle;">元&nbsp;</td>';
			html += '<td><div>';
			html += '<p><label><input type="checkbox" name="mansong" class="discount'+cengji+'" onchange="set_rule(\'discount\','+cengji+',this)"><span id="discount'+cengji+'">减现金</span></label></p>';
			html += '<p><label><input type="checkbox" name="mansong" class="free_shipping'+cengji+'"><span id="free_shipping'+cengji+'">免邮</span></label></p>';
//			html += '<p><label><input type="checkbox" name="mansong" class="give_point'+cengji+'" onchange="set_rule(\'give_point\','+cengji+',this)"><span id="give_point'+cengji+'">送积分</span></label></p>';
			html += '<p><label><input type="checkbox" name="mansong" class="give_coupon'+cengji+'" onchange="set_rule(\'give_coupon\','+cengji+',this)"><span id="give_coupon'+cengji+'">送优惠券</span></label></p>';
			html += '<p><label><input type="checkbox" name="mansong" class="gift_id'+cengji+'" onchange="set_rule(\'gift_id\','+cengji+',this)"><span id="gift_id'+cengji+'">送赠品</span></label></p>';
			html += '</div></td>';
			html += '<td><a href="javascript:void(0);" onclick="del_cengji('+cengji+')">删除</a></td>';
			html += '</tr>';
			$(".table-cj tbody").append(html);
			if(cengji == 10){
				$(".table-cj tfoot").hide();
			}
		}
	}

	function del_cengji(cengji){
		$(".table-cj tbody tr:last").remove();
	}

	$("input[name='type']").change(function(){
		var c = $(this).val();
		if(c == 2){
			$(".table-cj tfoot").show();
		}else{
			$(".table-cj tbody tr:gt(0)").remove();
			$(".table-cj tfoot").hide();
		}
	});

	//优惠类型点击
	function set_rule(type,num,e){
		if(type == 'discount'){
			discount(num,e);
		}else if(type == 'give_coupon'){
			give_coupon(num,e);
		}else if(type == 'gift_id'){
			gift_id(num,e);
		}
	}

	//减现金
	function discount(num,e){
		if(e.checked == true){
			var html = "减&nbsp;<input type='text' id='discount_input"+num+"' class='input-common' style='width:50px;vertical-align:middle;height: 16px;'/>&nbsp;元";
		}else{
			var html = "减现金";
		}
		$("#discount"+num).html(html);
	}

	//送积分
	//	function give_point(num,e){
	//		if(e.checked == true){
	//			var html = "送&nbsp;<input type='text' id='give_point_input"+num+"' class='input-common' style='width:50px;vertical-align:middle;height: 16px;'/>&nbsp;积分";
	//		}else{
	//			var html = "送积分";
	//		}
	//		$("#give_point"+num).html(html);
	//	}

	//送优惠券
	function give_coupon(num,e){
		if(e.checked == true){
			$.ajax({
				type : "post",
				url : "{:__URL('ADMIN_MAIN/promotion/coupontypelist')}",
				success : function(data) {
					var html = '送&nbsp;<select id="give_coupon_select'+num+'" class="select-common">';
					for(var i=0;i<data['data'].length;i++){
						html += '<option value="'+data['data'][i]['coupon_type_id']+'">'+data['data'][i]['coupon_name']+'</option>';
					}
					html += "</select>";
					$("#give_coupon"+num).html(html);
				}
			});
		}else{
			var html = "送优惠券";
			$("#give_coupon"+num).html(html);
		}
	}

	//送赠品
	function gift_id(num,e){
		if(e.checked == true){
			$.ajax({
				type : "post",
				url  : "{:__URL('ADMIN_MAIN/promotion/giftlist')}",
				data : {"type" : 1},
				success : function(data) {
					var html = '';
					html += '<div style="border: 1px solid grey">';
					for(var i=0;i<data['data'].length;i++){
						if(data['data'][i]['gift_num'] > data['data'][i]['gift_song_num']) {
							html += '<label class="checkbox-inline" style="display:inline;margin-left: 10px"><input type="checkbox" id="gift_id_select' + num + '" class="gift_id_select' + num + '" value="' + data['data'][i]['gift_id'] + '">&nbsp;'
									+ data['data'][i]['gift_name'] +
									'</label>';
							html += '&nbsp;<input type="number" id="gift_num'+num+'" class="gift_num' + num + '" style="width:50px;height: 14px;margin-top: 10px;vertical-align:middle"/>';
							html += '<span style="color: darkgrey"> &nbsp;剩余: </span>';
							html += '<span style="color: darkgrey">'+ (data['data'][i]['gift_num'] - data['data'][i]['gift_song_num'])+'</span>';
							html += '<br>';
						}
					}
					html += '</div>';
					$("#gift_id"+num).html(html);
				}
			});
		}else{
			var html = "";
			$("#gift_id"+num).html(html);
		}
	}

	//保存
	function addMansong(){
		var mansong_name  = $("#mansong_name").val();
		var start_time 	  = $("#start_time").val();
		var end_time 	  = $("#end_time").val();
		var type 		  = $("input[type='radio'][name='type']:checked").val();
		var range_type	  = '0';
		var rule 		  = '';
		var is_neigou 	  = 1;
		var obj1 		  = $(".table-cj tbody tr");
		var goods_sku_arr = '';
		for(var i=0;i<$goods_selected_array.length;i++){
			for(var k=0;k<$goods_selected_array[i].select_sku_arr.length;k++){
				goods_sku_arr += ','+ $goods_selected_array[i].goods_id +':'+
						$goods_selected_array[i].select_sku_arr[k].sku_id +':'+
						$goods_selected_array[i].select_sku_arr[k].n_discount+':'+
						$goods_selected_array[i].select_sku_arr[k].stock;
			}
		}

		if(goods_sku_arr.length > 0){
			goods_sku_arr = goods_sku_arr.substring(1);
		}

		if(!verify(mansong_name, start_time, end_time)){
			return false;
		}

		for(var i=1;i<=obj1.length;i++){
			//满减送价格
			if($("#price"+i).val() > 0){
				var price = $("#price"+i).val();
			}else{
				var price = 0;
				showMessage('error', '请输入优惠门槛金额');
				return false;
			}
			//减现金
			if($("input.discount"+i+"[type='checkbox']").is(':checked') == true){
				var discount = $("#discount_input"+i+"").val();
			}else{
				var discount = 0;
			}
			//免邮
			if($("input.free_shipping"+i+"[type='checkbox']").is(':checked') == true){
				var free_shipping = 1;
			}else{
				var free_shipping = 0;
			}
			//送积分
//			if($("input.give_point"+i+"[type='checkbox']").is(':checked') == true){
//				var give_point = $("#give_point_input"+i).val();
//			}else{
//				var give_point = 0;
//			}
			//送优惠券
			if($("input.give_coupon"+i+"[type='checkbox']").is(':checked') == true){
				var give_coupon = $("#give_coupon_select"+i).val();
			}else{
				var give_coupon = 0;
			}
			//送赠品
			if($("input.gift_id"+i+"[type='checkbox']").is(':checked') == true){
				var gift_id="";
				$('.gift_id_select'+i+':checked').each(function(){
					if($(this).parent().next().attr("value") == false){
						showMessage('error', '请填写赠品数量');
						return false;
					}
					if(Number($(this).parent().next().attr("value")) > Number($(this).parent().next().next().next().html())){
						showMessage('error', '赠品数量不能超过剩余数量');
						return false;
					}
					gift_id += $(this).attr("value") + ':' + $(this).parent().next().attr("value") +"/";
				});
			}else{
				var gift_id = 0;
			}
			if(discount+free_shipping+give_coupon+gift_id == 0){
				showMessage('error', '请至少选择一种优惠方式');
				return false;
			}
			rule += ';'+price+','+discount+','+free_shipping+','+give_coupon+','+gift_id;
		}
		rule = rule.substring(1);

		if(goods_sku_arr == '' && range_type == 0){
			showMessage('error', '请选择参加活动的商品');
			return false;
		}
		if(flag){
			return;
		}
		flag = true;
		$.ajax({
			type : "post",
			url : "{:__URL('ADMIN_MAIN/promotion/addNeiGou')}",
			data : {
				'mansong_name' 	 : mansong_name,
				'start_time'  	 : start_time,
				'end_time' 	     : end_time,
				'type'  	   	 : type,
				'range_type'   	 : range_type,
				'rule' 		     : rule,
				'goods_sku_array': goods_sku_arr,
				'is_neigou'		 : is_neigou
			},
			success : function(data) {
				if (data["code"] > 0) {
					showMessage('success', data["message"],"{:__URL('ADMIN_MAIN/promotion/mansonglist')}");
				}else{
					showMessage('error', data["message"]);
					flag = false;
				}
			}
		});
	}

	function verify(mansong_name, start_time, end_time){
		if(mansong_name == ''){
			$("#mansong_name").parent().find('.error').show();
			return false;
		}else{
			$(".error").hide();
		}
		if(start_time == '' || end_time == ''){
			$("#start_time").parent().find('.error').show();
			return false;
		}else{
			$(".error").hide();
		}
		return true;
	}

	//加载
	function LoadingInfo(page_index) {
		var group_id 	     = $("#group_id").val();
		var search_text      = $("#search_text").val();
		var search_sku 	     = $("#search_sku").val();
		var search_goods_sku = $("#search_goods_sku").val();
		var category_id_1    = $("#category_id_1").val();
		var category_id_2    = $("#category_id_2").val();
		var category_id_3    = $("#category_id_3").val();
		$.ajax({
			type : "post",
			url : "{:__URL('ADMIN_MAIN/goods/getsearchgoodslist')}",
			data : {
				"search_text" 	   : search_text,
				"search_sku"  	   : search_sku,
				"search_goods_sku" : search_goods_sku,
				"group_id"	  	   : group_id,
				"page_index"       : page_index,
				"page_size"   	   : $("#showNumber").val(),
				"state" 	  	   : 1 ,							//只显示已上架的商品
				"category_id_1"    : category_id_1,
				"category_id_2"	   : category_id_2,
				"category_id_3"	   : category_id_3
			},
			success : function(data) {
				$data_array = data['data'];
				var html = '';
				if (data['data'].length > 0) {
					$("#DiscountList").show();
					for (var i = 0; i < data['data'].length; i++) {
						if(data['data'][i].sku_arr.length > 0){
							var curr = data['data'][i];
							var row = curr.sku_arr.length;
							html +='<tr class="widget-list-item" id="select_'+curr["goods_id"]+'">';
							//选择框
							html +='<td style="text-align: center"><input type="checkbox" name="goods-select" goods_id="'+curr["goods_id"]+'" sku_id="'+curr.sku_arr[0]["sku_id"]+'"></td>';
							html +='<td rowspan="'+row+'" class="goods-image-td text-center"><div class="goods-image js-goods-image" style="width: 40px">';
							if(curr["picture_info"] != null){
								html +='<img src="'+__IMG(curr["picture_info"]['pic_cover_micro'])+'"></div></td>';
							}else{
								html +='<img src="__ROOT__/"></div></td>';
							}
							html +='<td rowspan="'+row+'" class="goods-meta"><p class="goods-title">';
							html +='<a href="'+__URL('SHOP_MAIN/goods/goodsinfo?goodsid='+curr["goods_id"])+'" target="_blank" class="new-window" title="'+curr["goods_name"]+'">'+curr["goods_name"]+'</a></p>';
							html +='<p class="goods-price">'+curr["price"]+'</p></td>';
							html +='<td rowspan="'+row+'"><p class="text-center">'+curr["category_id_name"]+'</p></td>';
							html +='<td rowspan="'+row+'"><p class="text-center">'+curr["goods_type"]+'</p></td>';

							for(var l = 0; l < curr.sku_arr.length; l++){
								if(l > 0){
									html +='<tr class="widget-list-item">';
									//选择框
									html +='<td style="text-align: center"><input type="checkbox" name="goods-select" goods_id="'+curr["goods_id"]+'" sku_id="'+curr.sku_arr[l]["sku_id"]+'"></td>';
								}
								html +='<td class="text-center">'+curr.sku_arr[l]["sku_name"]+'</td>';
								html +='<td class="text-center">'+curr.sku_arr[l]["material_code"]+'</td>';
								html +='<td class="text-center" id="stock_' + curr.sku_arr[l]["sku_id"] + '">'+curr.sku_arr[l]["stock"]+'</td>';
								html +='<td class="text-center" id="price_' + curr.sku_arr[l]["sku_id"] + '">'+curr.sku_arr[l]["price"]+'</td>';
								if($.inArray(curr.sku_arr[l]['sku_id'], $sku_id_selected_array) >= 0){
									html +='<td id="select_one_'+curr.sku_arr[l]['sku_id']+'" class="text-center"><button type="button" class="btn btn-default js-remove-reward"  onclick="cancel_join('+curr.sku_arr[l]['sku_id']+','+curr["goods_id"]+')">取消参加</button></td>';
								}else{
									html +='<td id="select_one_'+curr.sku_arr[l]['sku_id']+'"  class="text-center"><button type="button" class="btn btn-primary js-add-reward"  onclick="join('+curr.sku_arr[l]['sku_id']+','+curr["goods_id"]+')">参加活动</button></td>';
								}
								html +='</tr>';
							}
						}
					}
				} else {
					html += '<tr align="center"><td colspan="7">暂无符合条件的数据</td></tr>';
				}
				$("tbody.goods-list").html(html);
				initPageData(data["page_count"],data['data'].length,data['total_count']);
				$("#pageNumber").html(pagenumShow(jumpNumber,$("#page_count").val(),{$pageshow}));
			}
		});
	}

</script>
{/block}