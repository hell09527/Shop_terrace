{extend name="adminblue/base" /}
{block name="resources"/}
<script src="ADMIN_JS/My97DatePicker/WdatePicker.js" type="text/javascript"></script>
<style>
    .set-style h4{color:#0072D2;margin-left:10px;font-size:12px;}
    #motai-div{min-width: 60%}
    #myModal{min-width: 60%}
    .modal{left: 42%}
    /*.js-song-goods{display: none;}*/
</style>
{/block}
{block name="main"}
<div class="set-style">
    <h4>活动信息</h4>
    <dl>
        <dt><span style="color:red;">*</span>&nbsp;&nbsp;活动名称:</dt>
        <dd>
            <input type="text" id="mansong_name" maxlength="30" class="input-common"/>
            <p class="error">请输入活动名称</p>
        </dd>
    </dl>
    <dl>
        <dt><span style="color:red;">*</span>&nbsp;&nbsp;生效时间:</dt>
        <dd>
            <input class="input-medium input-common" autocomplete="off" type="text" id="start_time" style="width:250px;" onclick="WdatePicker({skin:'twoer',dateFmt:'yyyy-MM-dd HH:mm:ss'})" />
            <span class="mlr5">至</span>
            <input class="input-medium input-common" autocomplete="off" size="15"type="text" id="end_time" style="width:250px;" onclick="WdatePicker({skin:'twoer',dateFmt:'yyyy-MM-dd HH:mm:ss'})">
            <p class="error">请输入生效时间</p>
        </dd>
    </dl>

    <h4>优惠设置</h4>
    <dl>
        <dt>优惠方式:</dt>
        <dd>
            <label><input class="input-mini" type="radio" name="type" value="1" checked="checked" /> 普通优惠</label>
            <label><input class="input-mini" type="radio" name="type" value="2" /> 多级优惠</label>
            <p class="hint">（每级优惠不累积叠加）</p>
        </dd>
    </dl>
    <dl>
        <dt><span style="color:red;">*</span>&nbsp;&nbsp;优惠条件:</dt>
        <dd style="width:100%;">
            <div class="table-responsive">
                <table class="table table-cj">
                    <thead>
                    <tr>
                        <th>层级</th>
                        <th>优惠门槛</th>
                        <th>优惠方式（可多选）</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>1</td>
                        <td>满&nbsp;<input type="text" id="price1" class="input-common" style="width:50px;height: 20px;vertical-align: middle;">&nbsp;元</td>
                        <td>
                            <div>
                                <p>
                                    <label style="width: 200px">
                                        <input type="checkbox" name="mansong" class="discount1" onchange="set_rule('discount',1,this)" />&nbsp;订单金额优惠
                                    </label>
                                    <span id="discount1"></span>
                                </p>
                                <p>
                                    <label style="width: 100px">
                                        <input type="checkbox" name="mansong" class="free_shipping1" />&nbsp;免邮

                                    </label>
                                    <span id="free_shipping1"></span>
                                </p>
                                <p>
                                    <label style="width: 100px">
                                        <input type="checkbox" name="mansong" class="give_point1" onchange="set_rule('give_point',1,this)" />&nbsp;送积分
                                    </label>
                                    <span id="give_point1"></span>
                                </p>
                                <p>
                                    <label style="width: 100px">
                                        <input type="checkbox" name="mansong" class="give_coupon1" onchange="set_rule('give_coupon',1,this)" />&nbsp;送优惠券
                                    </label>
                                    <span id="give_coupon1"></span>
                                </p>
                                <p class="js-song-goods">
                                    <label style="width: 100px">
                                        <input type="checkbox" name="mansong" class="gift_id1" onchange="set_rule('gift_id',1,this)"/>&nbsp;送赠品
                                    </label>
                                    <span id="gift_id1"></span>
                                </p>
                            </div>
                        </td>
                        <td></td>
                    </tr>
                    </tbody>
                    <tfoot style="display:none;">
                    <tr>
                        <td colspan="4">
                            <a href="javascript:void(0)" onclick="add_reward()">+新增一级优惠</a>
                            <span class="gray pl20">最多可设置十个层级</span>
                        </td>
                    </tr>
                    </tfoot>
                </table>
            </div>
        </dd>
    </dl>

    <h4>选择活动商品</h4>
    {include file="adminblue/Promotion/selectNewGoods" /}
</div>
<dl style="text-align: center">
    <button class="btn-common btn-big" onclick="addMansong();">提交</button>
</dl>
<script>
    $(function(){
        LoadingInfo(1);
        // $("input[name='range_type']").click(function(){
        // 	if(parseInt($(this).val()) == 1){
        // 		$(".js-song-goods").hide();
        // 	}else{
        // 		//选择部分商品时会显示送赠品
        // 		$(".js-song-goods").show();
        // 	}
        // })
    });
    var flag = false;//防止重复提交

    //添加一级优惠
    function add_reward(){
        var len = $(".table-cj tbody tr").length;
        if(len >= 10){
            $(".table-cj tfoot").hide();
        }else{
            var cengji =  Number(len)+1;
            var html = '';
            html += '<tr>';
            html += '<td>'+cengji+'</td>';
            html += '<td>满&nbsp;<input type="text" id="price'+cengji+'" class="input-common" style="width:50px;height: 20px;vertical-align:middle;">元&nbsp;</td>';
            html += '<td><div>';
            html +='<p><label><input type="checkbox" name="mansong" class="discount'+cengji+'" onchange="set_rule(\'discount\','+cengji+',this)">&nbsp;订单金额优惠</label><span id="discount'+cengji+'"></span></p>';
            html += '<p><label><input type="checkbox" name="mansong" class="free_shipping'+cengji+'">&nbsp;免邮</label><span id="free_shipping'+cengji+'"></span></p>';
            html += '<p><label><input type="checkbox" name="mansong" class="give_point'+cengji+'" onchange="set_rule(\'give_point\','+cengji+',this)">&nbsp;送积分</label><span id="give_point'+cengji+'"></span></p>';
            html += '<p><label style="width: 100px"><input type="checkbox" name="mansong" class="give_coupon'+cengji+'" onchange="set_rule(\'give_coupon\','+cengji+',this)">&nbsp;送优惠券</label><span id="give_coupon'+cengji+'"></span></p>';
            html += '<p><label><input type="checkbox" name="mansong" class="gift_id'+cengji+'" onchange="set_rule(\'gift_id\','+cengji+',this)">&nbsp;送赠品</label><span id="gift_id'+cengji+'"></span></p>';
            html += '</div></td>';
            html += '<td><a href="javascript:void(0);" onclick="del_cengji('+cengji+')">删除</a></td>';
            html += '</tr>';
            $(".table-cj tbody").append(html);
            if(cengji == 10){
                $(".table-cj tfoot").hide();
            }
        }
    }

    function del_cengji(cengji){
        $(".table-cj tbody tr:last").remove();
    }

    $("input[name='type']").change(function(){
        var c = $(this).val();
        if(c == 2){
            $(".table-cj tfoot").show();
        }else{
            $(".table-cj tbody tr:gt(0)").remove();
            $(".table-cj tfoot").hide();
        }
    });

    //优惠类型点击
    function set_rule(type,num,e){
        if(type == 'discount'){
            discount(num,e);
        }else if(type == 'give_point'){
            give_point(num,e);
        }else if(type == 'give_coupon'){
            give_coupon(num,e);
        }else if(type == 'gift_id'){
            gift_id(num,e);
        }
    }

    //减现金
    function discount(num,e){
        if(e.checked == true){
            var html = "<div><div><input type='radio' name='discount"+num+"' value='discount'>&nbsp;减&nbsp;<input type='text' id='discount_input"+num+"' class='input-common' style='width:50px;height: 16px;vertical-align:middle'/>&nbsp;元</div><div style='margin-top: 5px'><input type='radio' name='discount"+num+"' value='discount_rate'>&nbsp;打&nbsp;<input type='text' id='discount_rate_input"+num+"' class='input-common' style='width:50px;height: 16px;vertical-align:middle'/>&nbsp;折</div></div>";
        }else{
            var html = "";
        }
        $("#discount"+num).html(html);
    }

    //送积分
    function give_point(num,e){
        if(e.checked == true){
            var html = "送&nbsp;<input type='text' id='give_point_input"+num+"' class='input-common' style='width:50px;vertical-align:middle'/>&nbsp;积分";
        }else{
            var html = "";
        }
        $("#give_point"+num).html(html);
    }

    //送优惠券
    function give_coupon(num,e){
        if(e.checked == true){
            $.ajax({
                type : "post",
                url : "{:__URL('ADMIN_MAIN/promotion/coupontypelist')}",
                success : function(data) {
                    var html = '送&nbsp;<select id="give_coupon_select'+num+'" class="select-common">';
                    for(var i=0;i<data['data'].length;i++){
                        html += '<option value="'+data['data'][i]['coupon_type_id']+'">'+data['data'][i]['coupon_name']+'</option>';
                    }
                    html += "</select>";
                    $("#give_coupon"+num).html(html);
                }
            });
        }else{
            var html = "";
            $("#give_coupon"+num).html(html);
        }
    }

    //送赠品
    function gift_id(num,e){
        if(e.checked == true){
            $.ajax({
                type : "post",
                url : "{:__URL('ADMIN_MAIN/promotion/giftlist')}",
                data : {"type" : 1},
                success : function(data) {
                    var html = '';
                    html += '<div style="border: 1px solid grey">';
                    for(var i=0;i<data['data'].length;i++){
                        if(data['data'][i]['gift_num'] > data['data'][i]['gift_song_num']) {
                            html += '<label class="checkbox-inline" style="display:inline;margin-left: 10px"><input type="checkbox" id="gift_id_select' + num + '" class="gift_id_select' + num + '" value="' + data['data'][i]['gift_id'] + '">&nbsp;'
                                    + data['data'][i]['gift_name'] +
                                    '</label>';
                            html += '&nbsp;<input type="number" id="gift_num'+num+'" class="gift_num' + num + '" style="width:50px;height: 14px;margin-top: 10px;vertical-align:middle"/>';
                            html += '<span style="color: darkgrey"> &nbsp;剩余: </span>';
                            html += '<span style="color: darkgrey">'+ (data['data'][i]['gift_num'] - data['data'][i]['gift_song_num'])+'</span>';
                            html += '<br>';
                        }
                    }
                    html += '</div>';
                    $("#gift_id"+num).html(html);
                }
            });
        }else{
            $("#gift_id"+num).html(' ')
        }
    }

    //保存
    function addMansong(){
        var mansong_name = $("#mansong_name").val();
        var start_time   = $("#start_time").val();
        var end_time     = $("#end_time").val();
        var type 	     = $("input[type='radio'][name='type']:checked").val();
        var range_type   = $("input[type='radio'][name='range_type']:checked").val();
        var rule 	     = '';
        var is_neigou    = '0';
        var obj1 		 = $(".table-cj tbody tr");

        if(!verify(mansong_name, start_time, end_time)){
            return false;
        }
        for(var i=1;i<=obj1.length;i++){
            //满减送价格
            if($("#price"+i).val() > 0){
                var price = $("#price"+i).val();
            }else{
                var price = 0;
                showMessage('error', '请输入优惠门槛金额');
                return false;
            }
            //减现金
            if($("input.discount"+i+"[type='checkbox']").is(':checked') == true){
                if($('input:radio[name="discount'+i+'"]:checked').val() == 'discount'){
                    var discount = $("#discount_input"+i+"").val();
                    var discount_rate = 0;
                }else{
                    var discount_rate = $("#discount_rate_input"+i+"").val();
                    var discount = 0;
                }
            }else{
                var discount = 0;
                var discount_rate = 0;
            }
            //免邮
            if($("input.free_shipping"+i+"[type='checkbox']").is(':checked') == true){
                var free_shipping = 1;
            }else{
                var free_shipping = 0;
            }
            //送积分
            if($("input.give_point"+i+"[type='checkbox']").is(':checked') == true){
                var give_point = $("#give_point_input"+i).val();
            }else{
                var give_point = 0;
            }
            //送优惠券
            if($("input.give_coupon"+i+"[type='checkbox']").is(':checked') == true){
                var give_coupon = $("#give_coupon_select"+i).val();
            }else{
                var give_coupon = 0;
            }
            //送赠品
            if($("input.gift_id"+i+"[type='checkbox']").is(':checked') == true){
                var gift_id="";
                $('.gift_id_select'+i+':checked').each(function(){
                    if($(this).parent().next().attr("value") == false){
                        showMessage('error', '请填写赠品数量');
                        return false;
                    }
                    if(Number($(this).parent().next().attr("value")) > Number($(this).parent().next().next().next().html())){
                        showMessage('error', '赠品数量不能超过剩余数量');
                        return false;
                    }
                    gift_id += $(this).attr("value") + ':' + $(this).parent().next().attr("value") +"/";
                });
            }else{
                var gift_id = 0;
            }
            if(discount+free_shipping+give_point+give_coupon+gift_id+discount_rate == 0){
                showMessage('error', '请至少选择一种优惠方式');
                return false;
            }
            rule += ';'+price+','+discount+','+free_shipping+','+give_point+','+give_coupon+','+gift_id+','+discount_rate;
        }
        rule = rule.substring(1);

        var goods_sku_arr = '';
        for(var j = 0;j < $goods_selected_array.length;j++){
            for(var k = 0;k < $goods_selected_array[j].select_sku_arr.length;k++){
                goods_sku_arr += ','+ $goods_selected_array[j].goods_id +':'+ $goods_selected_array[j].select_sku_arr[k].sku_id;
            }
        }
        if(goods_sku_arr.length > 0){
            goods_sku_arr = goods_sku_arr.substring(1);
        }

        if(goods_sku_arr == '' && range_type == 0){
            showMessage('error', '请选择参加活动的商品');
            return false;
        }
        if(flag){
            return;
        }
        flag = true;
        $.ajax({
            type : "post",
            url : "{:__URL('ADMIN_MAIN/promotion/addmansong')}",
            data : {
                'mansong_name'   : mansong_name,
                'start_time'     : start_time,
                'end_time'       : end_time,
                'type' 		     : type,
                'range_type'     : range_type,
                'rule' 		     : rule,
                'goods_sku_arr'  : goods_sku_arr,
                'is_neigou' 	 : is_neigou
            },
            success : function(data) {
                if (data["code"] > 0) {
                    showMessage('success', data["message"],"{:__URL('ADMIN_MAIN/promotion/mansonglist')}");
                }else{
                    showMessage('error', data["message"]);
                    flag = false;
                }
            }
        });
    }

    function verify(mansong_name, start_time, end_time){
        if(mansong_name == ''){
            $("#mansong_name").parent().find('.error').show();
            return false;
        }else{
            $(".error").hide();
        }
        if(start_time == '' || end_time == ''){
            $("#start_time").parent().find('.error').show();
            return false;
        }else{
            $(".error").hide();
        }
        return true;
    }
</script>
{/block}