{extend name="adminblue/base" /}
{block name="resources"/}
<script src="ADMIN_JS/My97DatePicker/WdatePicker.js" type="text/javascript"></script>
<style  type="text/css">
	.help-inline{height: 30px;line-height: 30px;}
	input[type="radio"]{margin-top:6px;}
	#motai-div{min-width: 60%}
	#myModal{min-width: 60%}
	.modal{left: 42%}
</style>
{/block}
{block name="main"}
<div class="set-style">
	<dl>
		<dt>活动名称:</dt>
		<dd><input type="text" id="discount_name" maxlength="10" class="input-common"><p class="error">请输入活动名称</p></dd>

	</dl>
	<dl>
		<dt>活动有效期:</dt>
		<dd>
			<input class="input-medium input-common" autocomplete="off" type="text" id="start_time" style="width:250px;"onclick="WdatePicker({skin:'twoer',dateFmt:'yyyy-MM-dd HH:mm:ss'})">
			<span class="mlr5">-</span>
			<input class="input-medium input-common" autocomplete="off" size="15" type="text" id="end_time" style="width:250px;"onclick="WdatePicker({skin:'twoer',dateFmt:'yyyy-MM-dd HH:mm:ss'})">
			<p class="error">请输入活动有效期</p>
			<p class="error">活动结束时间不能小于当前时间</p>
			<p class="error">活动结束时间不能小于开始时间</p>
		</dd>
	</dl>
	{include file="adminblue/Promotion/selectGoods" /}
</div>
<dl style="text-align: center">
	<button class="btn-common btn-big" onclick="addDiscount();">提交</button>
</dl>
<script>
	$(function(){
		$("[name='range_type']").parents("dl").hide();
		$('.type_dl dd').hide();
		$(".select-two thead th").eq(1).after("<th></th>");
		LoadingInfo(1);
		$("#some_pro").show();
	})
	function selected_goods(e){
		$(e).parents("ul.ui-nav-tab").find(".js-tab").removeClass("active");
		$(e).parents("li").addClass("active");
		$(".select-two").show();
		$(".select-one").hide();
		setDiscount();
	}
	function setDiscount(){
		$("input[type=number][name=discount]").each(function(i,d){
			var discount = $(d).val();
			var goodsid  = $(d).attr("goodsid");
			$(".discount_"+goodsid).children('input').val(discount);
		})
	}


	//刷新 已选商品
	function refresh_data(){
        var data     = $sku_selected_array;
		var html 	 = "";
		for (var i = 0; i < data.length; i++) {
			if(data[i].select_sku_arr.length > 0) {
				html += '<tr class="widget-list-item" id="selected_' + data[i]["goods_id"] + '">';
				html += '<td class="goods-image-td text-center"><div class="goods-image js-goods-image">';
				if (data[i]["picture_info"] != null) {
					html += '<img src="' + __IMG(data[i]["picture_info"]['pic_cover_micro']) + '"></div></td>';
				} else {
					html += '<img src="__ROOT__/"></div></td>';
				}
				html += '<td class="goods-meta"><p class="goods-title">';
				html += '<a href="' + __URL('SHOP_MAIN/goods/goodsinfo?goodsid=' + data[i]['goods_id']) + '" target="_blank" class="new-window" title="' + data[i]["goods_name"] + '">' + data[i]["goods_name"] + '</a></p>';
				html += '<p class="goods-price">' + data[i]["price"] + '</p></td>';
				html += '<td><p class="text-center">' + data[i]["category_id_name"] + '</p></td>';
				html += '<td></td>';
				html += '<td><p class="text-center">' + data[i]["goods_type"] + '</p></td>';
				html += '<td class="text-center">' + data[i]["stock"] + '</td>';
				html += '<td class="text-center"><button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal"  onclick="skuDetail(' + data[i]["goods_id"] + ',2,' + i + ')">详情</button></td>';
			}
		}
		$(".select-two tbody tr").remove();
		$(".select-two tbody").append(html);

	}


	//折扣
	function discount(event){
		var discount = parseFloat($(event).val()).toFixed(2);
		if(discount <0.01){
			$(event).val(0.01);
			discount = 0.01;
		}else if(discount >10){
			$(event).val(10);
			discount = 10;
		}
		var skuid = $(event).attr("skuid");
		$(".discount_"+skuid).children("input").val(discount);
	}

	//保存
	var flag = false;//防止重复提交
	function addDiscount(){
		var discount_name = $("#discount_name").val();
		var start_time	  = $("#start_time").val();
		var end_time 	  = $("#end_time").val();
		var range_type    = 0;
		var goods_sku_arr = '';

		for(var i=0;i<$data_array.length;i++){
			for(var k=0;k<$data_array[i].select_sku_arr.length;k++){
				goods_sku_arr += ','+ $data_array[i].goods_id +':'+ $data_array[i].select_sku_arr[k].sku_id +':'+ $data_array[i].select_sku_arr[k].discount;
			}
		}
		goods_sku_arr = goods_sku_arr.substring(1);


		if(verify(discount_name, start_time, end_time, goods_sku_arr, range_type)){
			if(flag){
				return;
			}
			$.ajax({
				type : "post",
				url : "{:__URL('ADMIN_MAIN/promotion/adddiscount')}",
				data : {
					'discount_name' : discount_name,
					'start_time'    : start_time,
					'end_time' 	    : end_time,
					'goods_sku_arr' : goods_sku_arr
				},
				success : function(data) {
					if (data["code"] > 0) {
						showMessage('success', data["message"],"{:__URL('ADMIN_MAIN/promotion/getdiscountlist')}");
					}else{
						showMessage('error', data["message"]);
						flag = false;
					}
				}
			});
		}
	}

	/**
	 *模块输入信息验证
	 */
	function verify(discount_name, start_time, end_time, goods_id_array){
		if(discount_name == ''){
			$("#discount_name").parent().find('.error').show();
			return false;
		}else{
			$(".error").hide();
		}
		if(start_time == '' || end_time == ''){
			$("#end_time").next('.error').show();
			return false;
		}else{
			$(".error").hide();
		}
		var dataTime = nowDate();
		var now = new Date(dataTime.replace("-", "/").replace("-", "/"));
		var end = new Date(end_time.replace("-", "/").replace("-", "/"));
		var start = new Date(start_time.replace("-", "/").replace("-", "/"));
		if(end < now){
			$("#end_time").next().next('.error').show();
			return false;
		}else{
			$(".error").hide();
		}
		if(end < start){
			$("#end_time").next().next().next('.error').show();
			return false;
		}else{
			$(".error").hide();
		}
		if(goods_id_array == ''){
			showTip("请至少选择一件商品","warning");
			return false;
		}
		return true;
	}

	function nowDate(){
		var myDate = new Date();
		//获取当前年
		var year=myDate.getFullYear();
		//获取当前月
		var month=myDate.getMonth()+1;
		//获取当前日
		var date=myDate.getDate();
		var h=myDate.getHours();//获取当前小时数(0-23)
		var m=myDate.getMinutes();//获取当前分钟数(0-59)
		var s=myDate.getSeconds();
		var now=year+'-'+month+"-"+date+" "+h+':'+m+":"+s;
		return now;
	}


</script>
{/block}